<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Andreas Nicolai">
<title>SIM-VICUS and NANDRAD Developers Manual</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url(../css/asciidoctor.css); /* Default asciidoc style framework - important */

/* roboto-condensed-regular - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: normal;
  font-weight: 400;
  src: url('../fonts/roboto-condensed-v25-latin-regular.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-regular.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-regular.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-regular.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-regular.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-regular.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-italic - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: italic;
  font-weight: 400;
  src: url('../fonts/roboto-condensed-v25-latin-italic.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-italic.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-italic.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-italic.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-italic.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-italic.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-700 - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: normal;
  font-weight: 700;
  src: url('../fonts/roboto-condensed-v25-latin-700.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-700.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-700.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-700.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}
/* roboto-condensed-700italic - latin */
@font-face {
  font-family: 'Roboto Condensed';
  font-style: italic;
  font-weight: 700;
  src: url('../fonts/roboto-condensed-v25-latin-700italic.eot'); /* IE9 Compat Modes */
  src: local(''),
       url('../fonts/roboto-condensed-v25-latin-700italic.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
       url('../fonts/roboto-condensed-v25-latin-700italic.woff2') format('woff2'), /* Super Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700italic.woff') format('woff'), /* Modern Browsers */
       url('../fonts/roboto-condensed-v25-latin-700italic.ttf') format('truetype'), /* Safari, Android, iOS */
       url('../fonts/roboto-condensed-v25-latin-700italic.svg#RobotoCondensed') format('svg'); /* Legacy iOS */
}

/* CUSTOMISATIONS */
/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#a90e22;
--secondarycolor:#9f1d0b;
--tertiarycolor: #ededed;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
body{font-family: "Roboto Condensed",sans-serif;}

h1,h2{color:var(--primarycolor) !important;font-family:"Roboto Condensed",sans-serif;}
h3,h4,h5,h6{color:var(--secondarycolor);font-family: "Roboto Condensed",sans-serif; }
.title{color:(--primarycolor) !important;font-family:"Roboto Condensed",sans-serif;font-style: normal; font-weight: normal;}
p{font-family: "Roboto Condensed",sans-serif ! important}
#toc.toc2 a{font-family:"Roboto Condensed",sans-serif;}
/*#toc.toc2 a:link{color:(--linkcolor) !important}
a:visited {color: #ffdbad;}
a.bare:visited {color: #204f83;}
a:hover {color: #317ed4;}
#toc.toc2 a:hover {color: #f1b464;}*/
/* code{background-color: var(--secondarycolor) !important;color:var(--white)} */
code,kbd,pre,samp{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;monospace;font-size:1em}

/* Table styles */
th{background-color: var(--tertiarycolor);color:var(--black) !important;}

#toctitle{color:var(--primarycolor);font-family: "Roboto Condensed",sans-serif;font-size: 1.6875em;}
#toc.toc2{background-color:#f4f8fd;}
/*#toc.toc2{background-color:#2C001E;color:white;}
#toc.toc2.a{color:white;}
*/

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
<link rel="stylesheet" href="../css/font-awesome.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SIM-VICUS and NANDRAD Developers Manual</h1>
<div class="details">
<span id="author" class="author">Andreas Nicolai</span><br>
<span id="email" class="email"><a href="https://github.com/ghorwin" class="bare">https://github.com/ghorwin</a></span><br>
<span id="revdate">0.5.0 (28.12.2022)</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_general_information">2. General Information</a>
<ul class="sectlevel2">
<li><a href="#_building_the_code">2.1. Building the code</a>
<ul class="sectlevel3">
<li><a href="#_setting_up_the_build_environment">2.1.1. Setting up the build environment</a></li>
<li><a href="#_building">2.1.2. Building</a></li>
<li><a href="#qmake">2.1.3. Development with Qt Creator</a></li>
<li><a href="#vc">2.1.4. Development with Visual Studio on Windows</a></li>
</ul>
</li>
<li><a href="#_coding_guidelines_and_rules">2.2. Coding Guidelines and Rules</a>
<ul class="sectlevel3">
<li><a href="#_programming_efficiency">2.2.1. Programming efficiency</a></li>
<li><a href="#_indentation_and_line_length_limit">2.2.2. Indentation and line length limit</a></li>
<li><a href="#_character_encoding_and_line_endings">2.2.3. Character encoding and line endings</a></li>
<li><a href="#_file_naming_and_header_guards">2.2.4. File naming and header guards</a></li>
<li><a href="#_namespaces">2.2.5. Namespaces</a></li>
<li><a href="#_class_and_variable_naming">2.2.6. Class and variable naming</a></li>
<li><a href="#_suggestions_for_writing_clean_and_neat_code">2.2.7. Suggestions for writing clean and neat code</a></li>
<li><a href="#_enumeration_types">2.2.8. Enumeration types</a></li>
<li><a href="#exception_handling">2.2.9. Exception handling</a></li>
<li><a href="#_documentation">2.2.10. Documentation</a></li>
<li><a href="#_git_workflow">2.2.11. Git Workflow</a></li>
<li><a href="#_tips_and_tricks">2.2.12. Tips and tricks</a></li>
</ul>
</li>
<li><a href="#qt_creator">2.3. Qt Creator Configuration</a>
<ul class="sectlevel3">
<li><a href="#_texteditor_settings">2.3.1. TextEditor settings</a></li>
<li><a href="#_coding_style">2.3.2. Coding style</a></li>
<li><a href="#_other_coding_style_settings">2.3.3. Other coding style settings:</a></li>
<li><a href="#_codemodel">2.3.4. Codemodel</a></li>
<li><a href="#_efficient_use_of_the_qt_creator_ide">2.3.5. Efficient use of the Qt Creator IDE</a></li>
</ul>
</li>
<li><a href="#_code_quality">2.4. Code Quality</a>
<ul class="sectlevel3">
<li><a href="#_frequently_check_for_potential_memory_leaks">2.4.1. Frequently check for potential memory leaks</a></li>
<li><a href="#_jacobian_matrix_pattern_correctness_check">2.4.2. Jacobian matrix pattern correctness check</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_nandrad_solver">3. NANDRAD Solver</a>
<ul class="sectlevel2">
<li><a href="#_model_initialization_procedure">3.1. Model Initialization Procedure</a>
<ul class="sectlevel3">
<li><a href="#_pre_solver_setup_steps">3.1.1. Pre-Solver-Setup steps</a></li>
<li><a href="#_model_setup">3.1.2. Model Setup</a></li>
<li><a href="#_climatic_loads">3.1.3. Climatic loads</a></li>
</ul>
</li>
<li><a href="#_model_objects_published_variables_and_variable_look_up">3.2. Model objects, published variables and variable look-up</a>
<ul class="sectlevel3">
<li><a href="#_model_instances">3.2.1. Model instances</a></li>
<li><a href="#_model_results">3.2.2. Model results</a></li>
<li><a href="#model_input_refs">3.2.3. Model inputs</a></li>
<li><a href="#variable_lookup">3.2.4. Variable lookup</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_sim_vicus_user_interface">4. SIM-VICUS User-Interface</a>
<ul class="sectlevel2">
<li><a href="#_3d_engine">4.1. 3D Engine</a>
<ul class="sectlevel3">
<li><a href="#_camera">4.1.1. Camera</a></li>
<li><a href="#_navigation">4.1.2. Navigation</a></li>
<li><a href="#_data_transfer">4.1.3. Data transfer</a></li>
<li><a href="#_shaders">4.1.4. Shaders</a></li>
</ul>
</li>
<li><a href="#_3d_calculations">4.2. 3D Calculations</a>
<ul class="sectlevel3">
<li><a href="#_polygons">4.2.1. Polygons</a></li>
<li><a href="#_normal_vector_calculation_of_polygons">4.2.2. Normal vector calculation of polygons</a></li>
</ul>
</li>
<li><a href="#_zustand_der_benutzeroberfläche_view_state">4.3. Zustand der Benutzeroberfläche (View State)</a>
<ul class="sectlevel3">
<li><a href="#_viewmode">4.3.1. <code>ViewMode</code></a></li>
</ul>
</li>
<li><a href="#UI-SelectionHandling">4.4. Auswahl von Objekten</a>
<ul class="sectlevel3">
<li><a href="#_auswahl_in_der_scene">4.4.1. Auswahl in der Scene</a></li>
</ul>
</li>
<li><a href="#UI-object_picking">4.5. Objekt-Pick-Operation</a></li>
</ul>
</li>
<li><a href="#_nandrad_fmu">5. NANDRAD FMU</a>
<ul class="sectlevel2">
<li><a href="#_debugging_nandrad_fmus_mit_qt_creator_und_mastersim">5.1. Debugging NANDRAD FMUs mit Qt Creator und MasterSim</a>
<ul class="sectlevel3">
<li><a href="#_linux_2">5.1.1. Linux</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_patchesdiffs">6. Patches/Diffs</a>
<ul class="sectlevel2">
<li><a href="#_änderungen_in_abgeleiteten_projekten_übernehmen">6.1. Änderungen in abgeleiteten Projekten übernehmen</a>
<ul class="sectlevel3">
<li><a href="#_ausgangspunkt">6.1.1. Ausgangspunkt</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document is for NANDRAD and SIM-VICUS developers. It discusses coding guidelines/rules and covers the underlying concepts of the solver and user interface implementation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_general_information">2. General Information</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_building_the_code">2.1. Building the code</h3>
<div class="paragraph">
<p>Building the code is fairly easy and only requires two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>setup the development environment</p>
</li>
<li>
<p>run the build scripts</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For actual development we recommend use of Qt Creator with the prepared <a href="#qmake">qmake build system</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are serious with own development of SIM-VICUS/NANDRAD I strongly suggest using Linux and Qt Creator - building the code on Linux is way faster than on Windows/Mac, and code insights and clang analysis in Qt Creator (including refactoring features) are much much better than in Visual Studio and/or XCode. But that&#8217;s just my humble opinion after a "few" years of working with all of these :-)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_setting_up_the_build_environment">2.1.1. Setting up the build environment</h4>
<div class="paragraph">
<p>Generally, you need a fairly up-to-date C/C++ compiler (that means: <code>c++11</code> features should be supported). Also, you need the Qt libraries. And you need cmake. That&#8217;s it, nothing else!</p>
</div>
<div class="sect4">
<h5 id="_windows">Windows</h5>
<div class="paragraph">
<p>There are build scripts for different VC and Qt versions. To keep things simple, all developers should install the same VC and Qt versions on development machines.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Team development works best if all use the same compilers and library versions. If you change build scripts and commit them to the repository, always make sure that you do not disrupt other peoples work by requiring alternative installation directories/tool versions.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Required versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Visual Studio 2019 (Community Edition suffices)</p>
</li>
<li>
<p>Qt 15.5.2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Installation steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install Visual Studio 2019 Community Online Installer from: <a href="https://visualstudio.microsoft.com/de/thank-you-downloading-visual-studio/?sku=Community&amp;rel=16#" class="bare">https://visualstudio.microsoft.com/de/thank-you-downloading-visual-studio/?sku=Community&amp;rel=16#</a> - Once downloaded, you only need to install basic development options.</p>
<div class="imageblock">
<div class="content">
<img src="./images/vc2019_install_options.png" alt="vc2019 install options">
</div>
<div class="title">Figure 1. Minimal selection of Visual Studio components to be installed</div>
</div>
<div class="paragraph">
<p>(Profiling tools are optional, profiling can be done very well with <code>valgrind</code> on Linux).</p>
</div>
</li>
<li>
<p>Download and install cmake. Either download from <a href="https://cmake.org" class="bare">https://cmake.org</a> or use <em>chocolatey</em> (<a href="https://chocolatey.org" class="bare">https://chocolatey.org</a>) and run</p>
<div class="literalblock">
<div class="content">
<pre>choco install cmake</pre>
</div>
</div>
</li>
<li>
<p>Download and install JOM (newer versions of the Qt maintenance tool do no longer install JOM together with QtCreator). Either download from <a href="https://cmake.org" class="bare">https://cmake.org</a> or use <em>chocolatey</em> (<a href="https://chocolatey.org" class="bare">https://chocolatey.org</a>) and run</p>
<div class="literalblock">
<div class="content">
<pre>choco install jom</pre>
</div>
</div>
</li>
<li>
<p>Download and install Qt Online Installer (<a href="https://www.qt.io/download-qt-installer" class="bare">https://www.qt.io/download-qt-installer</a>) and in the installation program select the <strong>5.15.2</strong> variant.</p>
</li>
<li>
<p>Download the VC Qt Tools addin (not really necessary for command line builds, but just in case you want to do development in VC directly - though I wouldn&#8217;t recommend it): <a href="https://marketplace.visualstudio.com/items?itemName=TheQtCompany.QtVisualStudioTools2019" class="bare">https://marketplace.visualstudio.com/items?itemName=TheQtCompany.QtVisualStudioTools2019</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, install a suitable git client (SmartGit is recommendet). Don&#8217;t forget to specify your git user name and email (user settings).</p>
</div>
</div>
<div class="sect4">
<h5 id="_linux">Linux</h5>
<div class="paragraph">
<p>On Linux it&#8217;s a walk in the park. Just install the build-essential package (g++/clang and cmake and qt5default packages). On Ubuntu simply run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; sudo apt install build-essential cmake qt5-default libqt5svg5-dev git qtcreator</pre>
</div>
</div>
<div class="paragraph">
<p>Also, install git or a suitable git client (SmartGit is recommendet). Don&#8217;t forget to specify your git user name and email:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; git config --global user.name "Your name here"
&gt; git config --global user.email "your_email@example.com"</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On Ubuntu 18.04 LTS the default Qt version is 5.9.5, so that is the oldest Qt version we are going to support. Whenever deprecated features are used to maintain compatibility with Qt 5.9.5, and where newer Qt features are available in more recent versions of Qt, the use of <code>#if QT_VERSION &gt;= 0x050a00</code> (and similar) is possible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_macos">MacOS</h5>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>HomeBrew does no longer work well for older MacOS versions, such as El Capitan. You may have problems installing certain tools. However, you may still use it to install newer gcc versions, needed for parallel builds.</p>
</div>
<div class="paragraph">
<p><em>Homebrew</em> can be used to install other programs (see <a href="https://brew.sh" class="bare">https://brew.sh</a>). Then</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; brew install cmake</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On El Capitan (MacOSX 10.11) Qt 5.11.3 is the <strong>last version</strong> to work. So you need to manually download this version. First select the Qt online installer (<a href="https://www.qt.io/download-qt-installer" class="bare">https://www.qt.io/download-qt-installer</a>)  and select version 5.11.3. This ensures that all developers use the same Qt version and avoid Qt-specific compilation problems.</p>
</div>
<div class="paragraph">
<p>Parallel gcc OpenMP code require a bit of extra work (to be documented later :-)</p>
</div>
<div class="paragraph">
<p>Also, install git or a suitable git client (SmartGit is recommendet). Don&#8217;t forget to specify your git user name and email:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; git config --global user.name "Your name here"
&gt; git config --global user.email "your_email@example.com"</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building">2.1.2. Building</h4>
<div class="paragraph">
<p>This works pretty much the same on all platforms. If you&#8217;ve successfully installed the development environment and can build basic Qt examples (open Qt Creator, pick an example, build it), you should be ok.</p>
</div>
<div class="paragraph">
<p>Go to the <code>build/cmake</code> subdirectory and run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; ./build.sh</pre>
</div>
</div>
<div class="paragraph">
<p>for Linux/MacOS or</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; build_VC2019_x64.bat</pre>
</div>
</div>
<div class="paragraph">
<p>or
    &gt; build_VC2019_x64_with_pause.bat</p>
</div>
<div class="paragraph">
<p>for Windows.</p>
</div>
<div class="paragraph">
<p>On Linux/MacOS you can pass a few command line options to adjust the build, for example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&gt; ./build.sh 8 release omp</pre>
</div>
</div>
<div class="paragraph">
<p>to compile in parallel with 8 CPUs and create a release build (optimized, no debug symbols) with OpenMP enabled. See the documentation in the <code>build.sh</code> script for more information.</p>
</div>
<div class="paragraph">
<p>Once the build has completed, the executables are copied into the <code>bin/release</code> (or <code>bin/release_x64</code> on Windows) directory.</p>
</div>
<div class="paragraph">
<p>On Windows, you may want to run <code>bin/release_x64/CreateDeploy_VC2019.bat</code> batch file to fetch all required DLLs (so that you can start the application by double-clicking the executables).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In case of build problems, inspect the build scripts and the path variables therein. You may need to set some environment variables yourself before running the scripts.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="qmake">2.1.3. Development with Qt Creator</h4>
<div class="paragraph">
<p>Development is best done with Qt Creator (it is way more efficient to work with than Visual Studio or Emacs/VI). The source code is split into many different libraries and executables, so you best open the prepared session project file <code>build/Qt/SIM-VICUS.pro</code>.</p>
</div>
<div class="paragraph">
<p>If you start working with Qt Creator, please mind the configuration rules described in <a href="#qt_creator">Qt Creator Configuration</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="vc">2.1.4. Development with Visual Studio on Windows</h4>
<div class="paragraph">
<p>To avoid the overhead of maintaining yet another build system (so far we have qmake/Qt Creator and cmake), we do not have Visual Studio solutions or project files. However, with the help of cmake you can easily generate VC project files for analysis of the code in Visual Studio.</p>
</div>
<div class="paragraph">
<p>Open a Visual Studio command line, ensure that <code>cmake</code> is in the path and then change into the <code>SIM-VICUS/build/cmake</code> directory. There, create a subdirectory, for example <code>vc</code>, change into this subdir, and run <code>cmake</code>.</p>
</div>
<div class="paragraph">
<p>Here are the commands when starting from within <code>SIM-VICUS/build/cmake</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="c">:: run from SIM-VICUS\build\cmake</span>

<span class="c">:: load VC compiler path</span>
<span class="s2">"C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"</span>

<span class="c">:: set CMAKE search prefix to find Qt library</span>
<span class="kd">set</span> <span class="kd">CMAKE_PREFIX_PATH</span><span class="o">=</span><span class="kd">C</span>:\Qt\5.15.2\msvc2019_64

<span class="c">:: create a subdirectory 'vc' and change into it</span>
<span class="nb">mkdir</span> <span class="kd">vc</span>
<span class="nb">cd</span> <span class="kd">vc</span>

<span class="c">:: generate cmake build system files</span>
<span class="kd">cmake</span> <span class="na">-G </span><span class="s2">"Visual Studio 16 2019"</span> <span class="na">-A </span><span class="kd">x64</span> ..</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates build system files for Visual Studio 2019 64-bit.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have a different version of Visual Studio installed, use the respective project file generator as described in <a href="https://cmake.org/cmake/help/latest/generator/Visual%20Studio%2016%202019.html">cmake-vc-generators</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The command will generate a set of <code>*.vcproj</code> files and an <code>sln</code> file:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/cmakevsgen.png" alt="cmakevsgen">
</div>
<div class="title">Figure 2. Minimal selection of Visual Studio components to be installed</div>
</div>
<div class="paragraph">
<p>You can open that and start developing in VC. Just mind that you may need to update your project files whenever new files have been added to the SIM-VICUS source code.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even if you&#8217;ve used Visual Studio in the past, we strongly advise against using it for SIM-VICUS development. The learning curve for Qt Creator is short and you will be rewarded with much better refactoring/code analysis features, plus much faster user interface (just try out the code completion!).</p>
</div>
<div class="paragraph">
<p>Though, Visual Studio has it&#8217;s benefits when it comes to specific debugging tasks in the internals of the solver.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_coding_guidelines_and_rules">2.2. Coding Guidelines and Rules</h3>
<div class="paragraph">
<p>Why coding guidelines and rules?</p>
</div>
<div class="paragraph">
<p>Well, even if you write software just for yourself, once the code base reaches a certain limit, you will appriciate well written code, so that you:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>avoid wasting time looking for variables, types, functions etc.</p>
</li>
<li>
<p>avoid re-writing similar functionality, simply because you don&#8217;t rememeber/find the already existing code pieces</p>
</li>
<li>
<p>avoid accidentilly breaking code because existing code is hard to read</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bottom line:</p>
</div>
<div class="paragraph">
<p><strong>Write clean and easy to read and maintain code, both for yourself and others in the team.</strong></p>
</div>
<div class="paragraph">
<p>The big question is: What is clean and easy to read/maintain?</p>
</div>
<div class="paragraph">
<p>Well, in my humble opinion this is mostly achieved by</p>
</div>
<div class="ulist">
<ul>
<li>
<p>doing stuff (mostly) the same way as everywhere in the code</p>
</li>
<li>
<p>using conventions that makes it easy to exchange code with others</p>
</li>
<li>
<p>using conventions that save you the trouble of remembering each and every variable/function etc.</p>
</li>
<li>
<p>write code that makes it easy for your development environment to assist <strong>you</strong> (see also section <a href="#qt_creator">Qt Creator</a> below)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below I&#8217;ve collected a bunch of rules/guidelines that help us achieve this goal of getting nice code, without restricting the individual coding style of each developer too much.</p>
</div>
<div class="sect3">
<h4 id="_programming_efficiency">2.2.1. Programming efficiency</h4>
<div class="paragraph">
<p>We are a small team and need to get the most out of our programming time.</p>
</div>
<div class="paragraph">
<p>Basic rule: <strong>Know your tools and choose the right tool for the job!</strong></p>
</div>
<div class="paragraph">
<p>For programmers, you need a good text editor (for everything that&#8217;s not actual code, or for quick hacks) and a decent development environment (IDE).  I&#8217;d say <em>Qt Creator</em> wins big time against Visial Studio, XCode and any other stuff out there, but let&#8217;s not start an <strong>emacs vs. the world</strong> flame war here :-).</p>
</div>
<div class="paragraph">
<p>Of course, you also need to handle svn/git, diff and merge tools etc. but text editor and IDE are the most important. I&#8217;d suggest <em>SmartGit</em> as git client - not because it is the best out there, but because most of the team members use it and can help you better with a problem.</p>
</div>
<div class="paragraph">
<p>Knowing the capabilities of your particular IDE you can write code such, that already while typing you can use auto-completion to its maximum. This will speed up your coding a lot and save you much unnecessary compilation time.
With code-checking-while-typing (see clang checks in Qt Creator), you&#8217;ll catch already 80% of typical compiler bugs, so we should use this.</p>
</div>
<div class="paragraph">
<p>Also, some of the naming conventions below help in an IDE to be fast, for example the <code>m_</code> prefix in member variable names, really speed up coding. You need to access a member variable: type <code>m_</code> and you&#8217;ll get only the member variables in the auto-completion, no mistake with local variables is possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="_indentation_and_line_length_limit">2.2.2. Indentation and line length limit</h4>
<div class="ulist">
<ul>
<li>
<p>only tabs for indentation, shown in display as 4 spaces - especially on larger monitors with higher resolutions this will allow you to see indentation levels easiy; and since we are using tabs, you may still switch your development environment to use 2 or 8 spaces, without interrupting other author&#8217;s code look</p>
</li>
<li>
<p>line length is not strictly limited, but keep it below 120 (good for most screens nowadays)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_character_encoding_and_line_endings">2.2.3. Character encoding and line endings</h4>
<div class="ulist">
<ul>
<li>
<p>Line endings LR (Unix/Linux) - see also git configuration below</p>
</li>
<li>
<p>UTF-8 encoding</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_file_naming_and_header_guards">2.2.4. File naming and header guards</h4>
<div class="ulist">
<ul>
<li>
<p>File name pattern:   <code>&lt;lib&gt;_&lt;NameInCamelCase&gt;.*</code>, for example: <code>IBK_ArgsParser.h</code> or <code>NANDRAD_Project.h</code></p>
</li>
<li>
<p>Header guards: <code>#ifndef &lt;filenameWithoutExtension&gt;H</code>, example: <code>#ifndef NANDRAD_ArgsParserH</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Rationale</strong></p>
</div>
<div class="paragraph">
<p>When header guards, filenames and class names use all the same strings (case-sensitive same strings), this makes refactoring a lot easier! And refactoring is something we need to do quite often. For example, if you need to fix a spelling mistake in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">NANDRAD_GlasingModel</span><span class="p">.</span><span class="n">h</span>

<span class="n">with</span>

<span class="cp">#ifndef NANDRAD_GlasingModelH
#define NANDRAD_GlasingModelH
</span>
<span class="p">...</span>

<span class="k">namespace</span> <span class="n">NANDRAD</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">GlasingModel</span> <span class="p">{</span>

<span class="p">...</span>

<span class="p">};</span> <span class="c1">// GlasingModel</span>

<span class="p">}</span> <span class="c1">// namespace NANDRAD</span>

<span class="cp">#endif // NANDRAD_GlasingModelH
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and similar for <code>NANDRAD_GlasingModel.cpp</code>, renaming everything in a consistent way is just a matter of search and replace "GlasingModel" with, for example, "GlazingSystem". This way you will not forget to rename include guards or comments - something, that otherwise happens very freqently during refactoring.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_namespaces">2.2.5. Namespaces</h4>
<div class="paragraph">
<p>Each library has its own namespace, matching the file prefix. Example: <code>NANDRAD::Project</code> get <code>NANDRAD_Project.h</code></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Never ever</strong> write <code>import namespace XXX</code>, not even for namespace <code>std</code> !!!</p>
</div>
<div class="paragraph">
<p>This is mostly a precaution, as in larger projects with many team members it is very likely that function names are similar or even the same, if written by different authors. When typing in your favourite development environment with code completion you are forced to write the namespace and the auto-completion will now only offer those functions/variables that are defined in the respective namespace (making it much harder to mistakely call a function you didn&#8217;t intend to call).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_class_and_variable_naming">2.2.6. Class and variable naming</h4>
<div class="ulist">
<ul>
<li>
<p>camel case for variable/type names, example: <code>thisNiceVariable</code></p>
</li>
<li>
<p>type/class names start with capital letter, example: <code>MyClassType</code> (together with namespace prefix nice for auto-completion of type names)</p>
</li>
<li>
<p>member variables start with <code>m_</code>, example: <code>m_myMemberVariableObject</code>(useful for auto-completion to get only member variables)</p>
</li>
<li>
<p>getter/setter functions follow Qt-Pattern:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_myStringMember</span><span class="p">;</span>

<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">myStringMember</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">setMyStringMember</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">str</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Never ever</strong> write <code>getXXX</code> !!!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reason for having strict rules for these access functions is two-fold:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>you do not need to remember the actual names for the getter/setter functions or the variable itself - knowing one will give you the name of the others (less stuff to remember)</p>
</li>
<li>
<p>efficiency: you can use the Qt-Creator feature &#8594; Refactor&#8594;Add getter/setter function when right-clicking on the member variable declaration</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_suggestions_for_writing_clean_and_neat_code">2.2.7. Suggestions for writing clean and neat code</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="c1">// Short function declarations may have the { in the same line</span>
<span class="kt">void</span> <span class="nf">someFunction</span><span class="p">(</span><span class="kt">int</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// indent with one tab character</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">t</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// also place the opening brace in this line</span>
        <span class="c1">// code</span>
    <span class="p">}</span>
    <span class="c1">// longer for-clauses with more than one line should place</span>
    <span class="c1">// the opening { into the next line to mark the opening scope.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_localVec</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">!=</span> <span class="n">m_localVec</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// code</span>
    <span class="p">}</span>
    <span class="c1">// similar rules apply for if and other clauses, for example</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">takeNextStep</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">firstStepCounter</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">repeat</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// code</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Longer function declarations in two or more lines should place</span>
<span class="c1">// the { in the next line to clearly mark the start of the scope.</span>
<span class="kt">void</span> <span class="n">someFunctionWithManyArguments</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">vec1</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">vec2</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="n">vec3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// code</span>
<span class="p">}</span>


<span class="c1">// The following source code shows typical indentation rules</span>
<span class="kt">void</span> <span class="n">indentationAndOtherRules</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// recommendation: use 'if (' instead of 'if( '</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">someCondition</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// code</span>
    <span class="p">}</span>
    <span class="c1">// put else in a separate line and put code comments</span>
    <span class="c1">// like this before the else clause to document what's</span>
    <span class="c1">// done in the else block</span>
    <span class="k">else</span> <span class="p">{</span>
       <span class="c1">//</span>
    <span class="p">}</span>

    <span class="c1">// put spaces between ; separated tokens in for loops</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// indent switch clauses like the example below</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="n">Well</span><span class="p">:</span>
             <span class="c1">// code</span>
             <span class="c1">// more code</span>
         <span class="k">break</span><span class="p">;</span> <span class="c1">// break on same level as case</span>

         <span class="c1">// document case clauses before the case</span>
         <span class="k">case</span> <span class="n">Sick</span><span class="p">:</span>
             <span class="c1">// code</span>
         <span class="k">return</span> <span class="s">"sick"</span><span class="p">;</span>

         <span class="c1">// when you declare local variables within switch</span>
         <span class="c1">// open a dedicated scope</span>
         <span class="k">case</span> <span class="n">DontKnow</span><span class="p">:</span> <span class="p">{</span>
             <span class="kt">int</span> <span class="n">var1</span><span class="p">;</span>  <span class="c1">// local variable, only valid for case clause</span>
             <span class="c1">// code</span>
         <span class="p">}</span>
         <span class="k">break</span><span class="p">;</span>

         <span class="c1">// if you have many short case clauses, you can use properly indented one-line versions</span>
         <span class="k">case</span> <span class="n">ABitSick</span>        <span class="p">:</span> <span class="k">return</span> <span class="s">"a bit sick"</span><span class="p">;</span>
         <span class="k">case</span> <span class="n">ALittleBitSick</span>  <span class="p">:</span> <span class="k">return</span> <span class="s">"a little bit sick"</span><span class="p">;</span>
         <span class="k">case</span> <span class="n">QuiteWell</span>       <span class="p">:</span> <span class="k">break</span><span class="p">;</span>

         <span class="nl">default:</span> <span class="p">;</span> <span class="c1">// only implement the default clause, when needed.</span>
                    <span class="c1">// Otherwise compiler will remind you about forgotten clauses</span>
                    <span class="c1">// (which might be quite helpful).</span>
    <span class="p">}</span> <span class="c1">// switch (condition)</span>
    <span class="c1">// in long nested scopes, document the end of the scope as done in the line above</span>

    <span class="c1">// another example of documented nested scopes</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">k</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// lots of code</span>

        <span class="p">}</span> <span class="c1">// for (j=k; j&lt;10; ++j)</span>

    <span class="p">}</span> <span class="c1">// for (k=0; k&lt;10; ++k)</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enumeration_types">2.2.8. Enumeration types</h4>
<div class="paragraph">
<p>Generally, enumeration types shall be named just as class names, that is using camel-case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">enum</span> <span class="n">ModelType</span> <span class="p">{</span>
  <span class="n">MT_Standard</span><span class="p">,</span>
  <span class="n">MT_MoreComplicated</span><span class="p">,</span>
  <span class="n">MT_ReallyReallyDifficult</span><span class="p">,</span>
  <span class="n">NUM_MT</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The individual enum values shall use camel-cased names, and a prefix that is composed of
initials of the actual enum type. This assists while typing, since one can just write "MT_" and will get the list of accepted enum types in the autocompletion list (avoids mixing enum value programm errors).</p>
</div>
<div class="paragraph">
<p>Add the <code>NUM_MT</code> enumeration value if keyword list support is needed (see documentation of code generator).</p>
</div>
<div class="paragraph">
<p>For keyword-list enums for parameters, integer parameters and flags there is the convention to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">enum</span> <span class="n">para_t</span> <span class="p">{</span>
  <span class="n">P_XXX</span><span class="p">,</span>
  <span class="p">...</span>
  <span class="n">NUM_P</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">intPara_t</span> <span class="p">{</span>
  <span class="n">IP_XXX</span><span class="p">,</span>
  <span class="p">...</span>
  <span class="n">NUM_PI</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">flag_t</span> <span class="p">{</span>
  <span class="n">F_XXX</span><span class="p">,</span>
  <span class="p">...</span>
  <span class="n">NUM_F</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a legacy naming that is just used everywhere in the code and best kept this way (never touch a running system :-)</p>
</div>
</div>
<div class="sect3">
<h4 id="exception_handling">2.2.9. Exception handling</h4>
<div class="paragraph">
<p>Basic rule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>during initialization, throw <code>IBK::Exception</code> objects (and <strong>only</strong> <code>IBK::Exception</code> objects in <strong>all code that uses the IBK library</strong>) : reason: cause of exception becomes reasonably clear from the exception message string and context and this makes catch-and-rethrow-code so much easier (see below).</p>
</li>
<li>
<p><strong>during calculation</strong> (in parallel code sections), <strong>avoid throwing Exceptions</strong> (i.e. write code that cannot throw); in error cases (like div by zero), test explicitely for such failure conditions and leave function with error codes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When throwing exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>use function identifier created with <code>FUNCID()</code> macro:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">FUNCID</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">);</span>

    <span class="p">...</span>
    <span class="k">throw</span> <span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">"Something went wrong"</span><span class="p">,</span> <span class="n">FUNC_ID</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Do not include function arguments in <code>FUNCID()</code>, unless it is important to distinguish between overloaded functions.</p>
</div>
<div class="paragraph">
<p>When raising exceptions, try to be verbose about the source of the exception, i.e. use <code>IBK::FormatString</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">FUNCID</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">);</span>

    <span class="p">...</span>
    <span class="k">throw</span> <span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span> <span class="n">IBK</span><span class="o">::</span><span class="n">FormatString</span><span class="p">(</span><span class="s">"I got an invalid parameter '%1' in object #%2"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">paraName</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">objectIndex</span><span class="p">),</span> <span class="n">FUNC_ID</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See documentaition of class <code>IBK::FormatString</code> (and existing examples in the code).</p>
</div>
<div class="sect4">
<h5 id="_exception_hierarchies">Exception hierarchies</h5>
<div class="paragraph">
<p>To trace the source of an error, keeping an exception trace is imported. When during simulation init you get an exception "Invalid unit ''" thrown from <code>IBK::Unit</code> somewhere, you&#8217;ll have a hard time tracing the source (also, when this is reported as error by users and debugging isn&#8217;t easily possible).</p>
</div>
<div class="paragraph">
<p>Hence, if you call a function that might throw, wrap it into a try-catch clause and throw on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">FUNCID</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">::</span><span class="n">myFunction</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="n">someOtherFunctionThatMightThrow</span><span class="p">();</span> <span class="c1">// we might get an exception here</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span> <span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>          <span class="c1">// we can rely on IBK::Exception here, since nothing else is allowed in our code</span>

        <span class="c1">// rethrow exception, but mind the prepended ex argument!</span>
        <span class="k">throw</span> <span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">IBK</span><span class="o">::</span><span class="n">FormatString</span><span class="p">(</span><span class="s">"I got an invalid parameter '%1' in object #%2"</span><span class="p">)</span>
            <span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">paraName</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">objectIndex</span><span class="p">),</span> <span class="n">FUNC_ID</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The error message stack will then look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>SomeClass::someOtherFunctionThatMightThrow    [Error]           Something went terribly wrong.
SomeClass::myFunction                         [Error]           I got an invalid parameter 'some parameter' in object #0815</code></pre>
</div>
</div>
<div class="paragraph">
<p>That should narrow it down a bit.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_documentation">2.2.10. Documentation</h4>
<div class="paragraph">
<p>Doxygen-style, prefer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cm">/*! Brief description of function.
    Longer multi-line documentation of function.
    \param arg1 The first argument.
    \param temperature A temperature in [C]
*/</span>
<span class="kt">void</span> <span class="nf">setParams</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">double</span> <span class="n">temperature</span><span class="p">);</span>

<span class="cm">/*! Mean temperature in [K]. */</span>
<span class="kt">double</span> <span class="n">m_meanTemperature</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mind to specify <strong>always</strong> physical units for physical value parameters and member variables!
Physical variables used for calculation should always be stored in base SI units.</p>
</div>
</div>
<div class="sect3">
<h4 id="_git_workflow">2.2.11. Git Workflow</h4>
<div class="paragraph">
<p>Since we are a small team, and we want to have close communication of new features/code changes, and also short code-review cycles, we use a single development branch <strong>master</strong> with the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CI is set up and ensures that after each push to <strong>origin/master</strong> the entire code builds without errors - so before pushing your changes, make sure the stuff builds</p>
</li>
<li>
<p>commit/push early and often, this will avoid getting weird merge conflicts and possibly breaking other peoples code</p>
</li>
<li>
<p>when pulling, use <strong>rebase</strong> to get a nice clean commit history (just as with subversion) - makes it easier to track changes and resolve errors arising in a specific commit (see solver regression tests)</p>
</li>
<li>
<p>before pulling (potentially conflicting) changes from <strong>origin/master</strong>, commit all your local changes and ideally get rid of temporary files &#8594; avoid stashing your files, since applying the stash may also give rise to conflicts and not everyone can handle this nicely</p>
</li>
<li>
<p>resolve any conflicts locally in your working directory, and take care not to overwrite other people&#8217;s code</p>
</li>
<li>
<p>use different commits for different features so that later we can distingish based on commit logs when a certain change was made</p>
</li>
<li>
<p><strong>never ever commit generated binary files</strong> (object code files, executables, binary files in general), as always, there are exceptions to this rule, for example PDFs for documentation etc, but keep in mind that all this stuff stays in the repository (eventually blowing it up to unreasonable sizes&#8230;&#8203; no one wants to download gigabytes of reposity data)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For now, try to avoid (lengthy) feature branches. However, if you plan to do a larger change (which might break compilation for some time to come) and, possibly, work on the master at the same time, feature branches are a good choice.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tips_and_tricks">2.2.12. Tips and tricks</h4>
<div class="sect4">
<h5 id="_detecting_uninitialized_variable_access_during_debugging">Detecting uninitialized variable access during debugging</h5>
<div class="paragraph">
<p>Accessing not initialized member variables or <strong>even worse</strong>, accessing member variables initialized with default values (hereby skipping over mandatory initialization steps), can be hard to track during development/debugging.</p>
</div>
<div class="paragraph">
<p>Hence initialize variables that <strong>need to be initialized</strong> with values you will recognized. Using C++11 features, you should write code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">SomeClass</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="c1">// nullptr is good to recognize pointers as "not initialized"</span>
    <span class="n">SomeType</span>    <span class="o">*</span><span class="n">m_ptrToSomeType</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

    <span class="c1">// use some unlikely "magic number" to see that a variable is not initialized (yet)</span>
    <span class="kt">double</span>      <span class="n">m_cachedCalculationValue</span> <span class="o">=</span> <span class="mi">999</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="qt_creator">2.3. Qt Creator Configuration</h3>
<div class="paragraph">
<p>Please use the following Qt Creator text editor and coding style configuration. Some tipps on efficient Qt Creator use are given below.</p>
</div>
<div class="sect3">
<h4 id="_texteditor_settings">2.3.1. TextEditor settings</h4>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_TextEditorConfig.png" alt="QtCreator TextEditorConfig">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coding_style">2.3.2. Coding style</h4>
<div class="paragraph">
<p>Create a custom coding style (copy from Qt-style), name it "IBK" and change it as follows (not shown configuration pages need not be changed):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_CodingStyle1.png" alt="QtCreator CodingStyle1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_CodingStyle2.png" alt="QtCreator CodingStyle2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_CodingStyle3.png" alt="QtCreator CodingStyle3">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_CodingStyle4.png" alt="QtCreator CodingStyle4">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_CodingStyle5.png" alt="QtCreator CodingStyle5">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_coding_style_settings">2.3.3. Other coding style settings:</h4>
<div class="ulist">
<ul>
<li>
<p>C++ &#8594; Namenskonventionen für Dateien &#8594; Kleinbuchstaben für Dateinamen verwenden = off</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_codemodel">2.3.4. Codemodel</h4>
<div class="paragraph">
<p>The code model is responsible for checking the code while typing and can detect quite a few problems from mismatching types, misspelled variables, missing ; and basically everything a regular compiler can spot. In fact, the code model just runs the code through the first stages of the compiler - saving you quite a bit of compilation time.</p>
</div>
<div class="paragraph">
<p>The code model integration into Qt Creator is pretty nice, so you should activate it.</p>
</div>
<div class="paragraph">
<p>You can use one of the provided code model configurations, but that might lead to excessive number of errors/warnings. Rather configure the code model with the following parameters:</p>
</div>
<div class="listingblock">
<div class="title">Codemodel Options for CLang on Linux</div>
<div class="content">
<pre>-Weverything -Wno-c++98-compat -Wno-c++98-compat-pedantic -Wno-unused-macros -Wno-newline-eof -Wno-exit-time-destructors -Wno-global-constructors -Wno-gnu-zero-variadic-macro-arguments -Wno-documentation -Wno-shadow -Wno-switch-enum -Wno-missing-prototypes -Wno-used-but-marked-unused -Wno-shorten-64-to-32 -Wno-old-style-cast</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_efficient_use_of_the_qt_creator_ide">2.3.5. Efficient use of the Qt Creator IDE</h4>
<div class="ulist">
<ul>
<li>
<p>Use F2 to lookup declaration/definitions of symbols (that means: variable, function declaration, type, &#8230;&#8203;)</p>
</li>
<li>
<p>Use F4 to switch between header and cpp file</p>
</li>
<li>
<p>Use Shift-F4 to switch between UI-designer and h/cpp file</p>
</li>
<li>
<p>Ctrl+Shift+R - rename symbol using refacturing (i.e. everywhere that this symbol occurs in the source code)</p>
</li>
<li>
<p>"Alle Verweise" anzeigen im Kontextmenü (wenn man auf ein Symbol rechts-klickt)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_refactoring_feature">Refactoring feature</h5>
<div class="paragraph">
<p>See <a href="https://doc.qt.io/qtcreator/creator-editor-refactoring.html" class="bare">https://doc.qt.io/qtcreator/creator-editor-refactoring.html</a> for a comprehensive list!</p>
</div>
<div class="paragraph">
<p>Make use of the refactoring feature (right-click on a symbol/variable/function/switch&#8230;&#8203;) and select "Refacture" in the context menu.</p>
</div>
<div class="paragraph">
<p>Useful features are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add definition in C++-File (when clicking on a function declaration)</p>
</li>
<li>
<p>add getter/setter functions (when clicking on a member variable with m_xxxYyyyZzzz naming)</p>
</li>
<li>
<p>complete switch clause (when clicking on a switch clause)</p>
</li>
<li>
<p>rename (Ctrl+Shift+R shortcut)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_quality">2.4. Code Quality</h3>
<div class="paragraph">
<p>This section discusses a few techniques that help you write/maintain high quality code.</p>
</div>
<div class="sect3">
<h4 id="_frequently_check_for_potential_memory_leaks">2.4.1. Frequently check for potential memory leaks</h4>
<div class="paragraph">
<p>Use valgrind to check for memory leaks in regular intervals:</p>
</div>
<div class="paragraph">
<p>First run only initialization with <code>--test-init</code> flag.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> valgrind <span class="nt">--track-origins</span><span class="o">=</span><span class="nb">yes</span> <span class="nt">--leak-check</span><span class="o">=</span>full ./NandradSolver /path/to/project <span class="nt">--test-init</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get an output like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>...
Stopping after successful initialization of integrator.
Total initialization time: 802 ms
==15560==
==15560== HEAP SUMMARY:
==15560==     in use at exit: 0 bytes in 0 blocks
==15560==   total heap usage: 3,776 allocs, 3,776 frees, 1,101,523 bytes allocated
==15560==
==15560== All heap blocks were freed -- no leaks are possible
==15560==
==15560== For counts of detected and suppressed errors, rerun with: -v
==15560== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do this check with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>just the initialization part (i.e. with <code>--test-init</code>) parameter</p>
</li>
<li>
<p>run the initialization with some error in the input file to check if temporary variables during initialization are cleaned up correctly</p>
</li>
<li>
<p>also run a small part of the simulation, to check if something goes wrong during actual solver init and if tear-down is done correctly</p>
</li>
<li>
<p>run a small part of the simulation, then break (<code>Ctrl+C</code>) and check if code cleanup after error abort is done correctly</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Of course, in very flexible code structures as in NANDRAD solver, where many code parts are only executed for certain parameter combinations, checking all code variables for consistent memory allocation/deallocation is nearly impossible. Hence, writing safe code in the first place should be highest priority.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_example_avoiding_memory_leaks">Example: Avoiding memory leaks</h5>
<div class="paragraph">
<p>NANDRAD creates model objects on the heap during initialization (never during solver runtime!). Since the model objects are first initialized before ownership is transferred, you should always ensure proper cleanup in case of init exceptions. Use code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">ModelObject</span> <span class="o">*</span> <span class="n">modelObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ModelObject</span><span class="p">;</span> <span class="c1">// does not throw</span>
<span class="n">m_modelContainer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">modelObject</span><span class="p">);</span> <span class="c1">// transfer ownership, does not throw</span>

<span class="n">modelObject</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(...);</span> <span class="c1">// this may throw, but model object will be cleaned as part of m_modelContainer cleanup</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is code between creation and ownership transfer, use code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ModelObject</span><span class="o">&gt;</span> <span class="n">modelObject</span><span class="p">(</span><span class="k">new</span> <span class="n">ModelObject</span><span class="p">);</span>

<span class="n">modelObject</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(...);</span> <span class="c1">// this may throw</span>

<span class="n">m_modelContainer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">modelObject</span><span class="p">.</span><span class="n">release</span><span class="p">());</span> <span class="c1">// transfer ownership</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jacobian_matrix_pattern_correctness_check">2.4.2. Jacobian matrix pattern correctness check</h4>
<div class="paragraph">
<p>It is easily possible to forget a specific interrelation and dependency when publishing model variable dependencies. The resulting sparse Jacobian-pattern may be incomplete.</p>
</div>
<div class="paragraph">
<p>An incomplete Jacobian-pattern has the following consequences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Newton-iteration may frequently not converge - the number of NonLinConvFails increases. Because of this, often a restart with new Newton-matrix setup and factorization is needed, which is expensive.</p>
</li>
<li>
<p>The Newton-iteration may converge, yet not entirely correct. This is picked up by the truncation error test, and leads potentially to an increase of ErrorFails and resulting step-rejections. Redoing a step is very bad for performance; time step is reduced, Jacobian matrix is recomputed and factorized&#8230;&#8203; overall, the performance suffers.</p>
</li>
<li>
<p>The actual time to compose and factorize the Jacobian matrix may, however, be shorter when elements are missing. In some cases this can be desired, for example, when the Jacobian contains many very small values in its pattern. Then, it is often meaningful to drop these in the calculation. For example, the network interaction due to temperature-dependent viscosity changes may be omitted from the Jacobian. Also, the dependency of network element balance equations on a thermostat-controlled valve somewhere upstream reduces from element to element, until after several pipe segments the impact is no longer significant and could be dropped from the Jacobian.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generally speaking, the Jacobian pattern should be complete and correct for most models, and this should be regularly checked.</p>
</div>
<div class="sect4">
<h5 id="_automatic_consistency_check">Automatic consistency check</h5>
<div class="paragraph">
<p>Under the condition that Jacobian matrixes for Dense and KLU are identical, the simulation should also run - theoretically - with identical results and solver statistics, only a bit slower in the case of the Dense matrix. Hence, it is a good first test to run the same test case with both matrix solvers and check, if there are significant differences.</p>
</div>
<div class="paragraph">
<p>When running a test case with the following options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> NandradSolver test.nandrad <span class="nt">--les-solver</span><span class="o">=</span>Dense <span class="nt">--integrator</span><span class="o">=</span>ImplicitEuler <span class="nt">-o</span><span class="o">=</span><span class="s2">"test.Dense"</span>
<span class="o">&gt;</span> NandradSolver test.nandrad <span class="nt">--les-solver</span><span class="o">=</span>KLU <span class="nt">-o</span><span class="o">=</span><span class="s2">"test.KLU"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>this will generate two sets of output directories with (hopefully) identical physical results and statistics. However, even if the Jacobian pattern used by the sparse matrix solver is 100% correct, the rounding errors related to the LU factorization of the dense matrix, or the factorization of the re-arranged sparse matrix will likely give minor changes in the Newton solution which may accumulate over time and cause small differences in counters.</p>
</div>
<div class="paragraph">
<p>Still, the test can be done automated by running the script <code>run_JacobianPatternTest.sh</code> in the <code>build/cmake</code> directory.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Run the script <code>run_JacobianPatternTest.sh</code> for the release-build NANDRAD solver without any specific modifications (except maybe the Network-initial condition hack, as described below).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The script will run all test cases with Dense and KLU solvers, compare results and statistics and flag all test cases with differences as failed.</p>
</div>
<div class="paragraph">
<p>Once a test case has been manually checked, a file with suffix <code>jac_checked</code> instead of <code>nandrad</code> can be placed side-by-side the NANDRAD project file. For all test cases with such a <code>jac_checked</code> file, the test will be skipped and the case will be marked as successful.</p>
</div>
</div>
<div class="sect4">
<h5 id="_manually_checking_jacobian_patterns">Manually checking Jacobian patterns</h5>
<div class="paragraph">
<p>The sparse Jacobian pattern can be checked by comparing it against a full dense Jacobian matrix. If the sparse pattern is correct, the generated Jacobian matrixes must be identical, under the following conditions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jacobian matrix data is compared as originally computed in memory. Hence, dumping the data in binary format is required. When writing Jacobian data in ASCII format, there will be accuracy loss and hence small differences will be computed stemming from rounding errors.</p>
</li>
<li>
<p>Jacobian matrixes generated with DQ-algorithms must be generated using the same calculation method for the increments. For example, the increment calculation method in the SUNDIALS solvers is different from those in IBKMK-library - results will not be comparible. It is advised to use only IBKMK-matrix classes to generate Jacobian data.</p>
</li>
<li>
<p>All states must be identical, when the Jacobians are generated. This is usually only guaranteed at the begin of a simulation. Thus, the typical procedure is to generate the Jacobian, dump it to file and stop the solver right away.</p>
</li>
<li>
<p>The system function must be 100% deterministic and only dependent on the current set of states provided to the function. This also means that all embedded iterative/numerical algorithms must be started with <strong>exactly</strong> the same initial conditions. This applies, for example, to the Newton solver that is used for the hydraulic network calculation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To generate the Jacobians to compare, the following changes need to be made in the solver&#8217;s source code:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>in <code>SOLFRA_JacobianSparseCSR.cpp</code> enable binary dumping of Jacobian matrix and enabling the define</p>
</li>
<li>
<p>in <code>SOLFRA_LESDense.cpp</code>  enable binary dumping of Jacobian matrix and enabling the define</p>
</li>
<li>
<p>in <code>NM_HydraulicNetworkModel.cpp</code> in function <code>HydraulicNetworkModelImpl::solve()</code> enable the if-block to ensure usage of the same initial conditions for the Newton method.</p>
</li>
<li>
<p>compile the solver with CMake in release mode</p>
</li>
<li>
<p>copy the solver executable <code>NandradSolver</code> to <code>NandradSolverJacDump</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you can generate the Jacobians for a specific test case using the command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> jacdump.sh test.nandrad</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will run the test case with KLU and Dense (the latter with ImplicitEuler integrator) and then rename the dumped Jacobians to <code>test_jacobian_dense.bin</code> and <code>test_jacobian_sparse.bin</code>.</p>
</div>
<div class="paragraph">
<p>Now open these files with the <em>JacobianMatrixViewer</em> tool (see <a href="https://github.com/ghorwin/JacobianMatrixViewer" class="bare">https://github.com/ghorwin/JacobianMatrixViewer</a>).</p>
</div>
<div class="paragraph">
<p>If the matrixes match, you can run the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> checked.sh test.nandrad</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will create the <code>test.jac_checked</code> file and also remove the <code>bin</code>-files.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nandrad_solver">3. NANDRAD Solver</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter discusses the underlying fundamentals and algorithms, as well as initialization and calculation procedures.</p>
</div>
<div class="sect2">
<h3 id="_model_initialization_procedure">3.1. Model Initialization Procedure</h3>
<div class="sect3">
<h4 id="_pre_solver_setup_steps">3.1.1. Pre-Solver-Setup steps</h4>
<div class="paragraph">
<p>The following steps are done when initializing the model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>parsing command-line and handling early command line options</p>
</li>
<li>
<p>setting up directory structure and message handler/log file</p>
</li>
<li>
<p>creating <code>NANDRAD::Project</code> instance</p>
</li>
<li>
<p>setting default values via call to <code>NANDRAD::Project::initDefaults()</code></p>
</li>
<li>
<p>reading the project file (only syntactical checks are done, and for IBK::Parameter static arrays with default units in keyword list, a check for compatible units is made), may overwrite defaults; correct units should be expected in the data model after reading the project file (maybe add suitable annotation to code generator?)</p>
</li>
<li>
<p>merge similarly behaving construction instances (reduce data structure size)</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>From now on the project data structure remains unmodified in memory until end of solver runtime and persistent pointers can be used to address parameter sets. This means no vector resizing is allowed, no more data members may be added/removed, because this would invalidate pointers/references to these vector elements.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_error_checking_in_nandrad_data_model">Error checking in NANDRAD data model</h5>
<div class="paragraph">
<p>Some basic error checking can be made in the NANDRAD Project data structure that is independent of the actual simulation-dependend model setup. These tests are done in functions called <code>checkParameters()</code>.</p>
</div>
<div class="paragraph">
<p>Basically, the NANDRAD Model calls these <code>checkParameters()</code> functions for all data objects. The functions should check for sane values (i.e. positive cross-section areas, non-negative coefficients, and generally all parameters with known limits. Also, the existence of parameters when required should be tested (in sofar this is independent of specific modelling options).</p>
</div>
<div class="paragraph">
<p>Error handling shall be done in such a way, that when parameter errors are found, the user can quickly identify the offending XML tag and fix the problem.</p>
</div>
<div class="listingblock">
<div class="title">Parameter checking function of a vector element is wrapped in a try-catch clause with indication on where the error occurred.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">m_project</span><span class="o">-&gt;</span><span class="n">m_materials</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">NANDRAD</span><span class="o">::</span><span class="n">Material</span> <span class="o">&amp;</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">m_project</span><span class="o">-&gt;</span><span class="n">m_materials</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">try</span> <span class="p">{</span>
		<span class="n">mat</span><span class="p">.</span><span class="n">checkParameters</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">catch</span> <span class="p">(</span><span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span> <span class="o">&amp;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">throw</span> <span class="n">IBK</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">IBK</span><span class="o">::</span><span class="n">FormatString</span><span class="p">(</span><span class="s">"Error initializing material #%1 '%2' (id=%3)."</span><span class="p">)</span>
							 <span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">mat</span><span class="p">.</span><span class="n">m_displayName</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="n">mat</span><span class="p">.</span><span class="n">m_id</span><span class="p">),</span> <span class="n">FUNC_ID</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, that in the exception the index, optional display name and ID is printed - one of these should be sufficient to find the problematic XML block.</p>
</div>
<div class="paragraph">
<p>The location of error is reported by the calling function, inside the <code>checkParameters()</code> function it is sufficient to indicate the actual parametrization error:</p>
</div>
<div class="listingblock">
<div class="title">Using consistent error checking functionality for IBK::Parameter data types.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">Material</span><span class="o">::</span><span class="n">checkParameters</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// check for mandatory and required parameters and</span>
	<span class="c1">// check for meaningful value ranges</span>
	<span class="n">m_para</span><span class="p">[</span><span class="n">P_Density</span><span class="p">].</span><span class="n">checkedValue</span><span class="p">(</span><span class="s">"kg/m3"</span><span class="p">,</span> <span class="s">"kg/m3"</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span>
								   <span class="s">"Density must be &gt; 0.01 kg/m3."</span><span class="p">);</span>
	<span class="n">m_para</span><span class="p">[</span><span class="n">P_HeatCapacity</span><span class="p">].</span><span class="n">checkedValue</span><span class="p">(</span><span class="s">"J/kgK"</span><span class="p">,</span> <span class="s">"J/kgK"</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span>
								   <span class="s">"Heat capacity must be &gt; 100 J/kgK."</span><span class="p">);</span>
	<span class="n">m_para</span><span class="p">[</span><span class="n">P_Conductivity</span><span class="p">].</span><span class="n">checkedValue</span><span class="p">(</span><span class="s">"W/mK"</span><span class="p">,</span> <span class="s">"W/mK"</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span>
								   <span class="s">"Thermal conductivity must be &gt; 1e-5 W/mK."</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The exception hierarchy will be collected in the <code>IBK::Exception</code> objects and printed in the error stack (see also <a href="#exception_handling">Exception handling</a>).</p>
</div>
<div class="paragraph">
<p>For (the very frequently occurring) <code>IBK::Parameter</code> data type, the <code>checkedValue()</code> is most convenient to both check for existence and validity of an <code>IBK::Parameter</code> (including matching units). The function also returns the value in the requested target unit (see documentation for <code>IBK::Parameter::checkedValue()</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_quick_access_connections_between_data_objects_during_runtime">Quick-access connections between data objects during runtime</h5>
<div class="paragraph">
<p>Access of model parameters is very fast during simulation, if looping and searching through the data structure can be avoided. Pointers between data structures are an efficient way of relating data objects. For example, a construction layer references the respective material data via ID number of the material. During the initialization (specifically in <code>checkParameters()</code> a pointer is obtained to the material and stored in the object. This requires, of course, that the pointer may never become invalidated during the life-time of the simulation. Hence the <strong>strict requirement</strong> of not-changing vector sizes (see above).</p>
</div>
<div class="paragraph">
<p>If a references data element is missing, an error message is thrown (this is part of the reason, why this lookup of referenced data objects is done and checked in <code>checkParameters()</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_summary">Summary</h5>
<div class="ulist">
<ul>
<li>
<p>implement <code>checkParameters()</code> functions in NANDRAD data model classes</p>
</li>
<li>
<p>for cross references between data members (via ID numbers of ID names), create fast access pointer links in this function</p>
</li>
<li>
<p>indicate the source of an error (i.e. the actual object) in the <strong>calling</strong> function</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_model_setup">3.1.2. Model Setup</h4>
<div class="paragraph">
<p>Now the actual model initialization starts.</p>
</div>
<div class="paragraph">
<p><strong>TODO</strong> : model specific documentation</p>
</div>
</div>
<div class="sect3">
<h4 id="_climatic_loads">3.1.3. Climatic loads</h4>
<div class="sect4">
<h5 id="_implementation">Implementation</h5>
<div class="paragraph">
<p>The <code>Loads</code> model is a pre-defined model that is always evaluated first whenever the time point has changed. It does not have any other dependencies.</p>
</div>
<div class="paragraph">
<p>It provides all resulting variables as <code>constant</code> (during iteration) result variables, which can be retrieved and utilized by any other model.</p>
</div>
<div class="paragraph">
<p>With respect to solar radiation calculation, during initialization it registers all surfaces (with different orientation/inclination) and provides an ID for each surface. Then, models can request direct and diffuse radiation data, as well as incidence angle for each of the registered surfaces.</p>
</div>
</div>
<div class="sect4">
<h5 id="_registering_surfaces">Registering surfaces</h5>
<div class="paragraph">
<p>Each construction surface (interface) with outside radiation loads registers itself with the Loads object, hereby passing the interface object ID as argument and orientation/inclination of the surface. The loads object itself registers this surface with the climate calculation module (CCM) and retrieves a surface ID. This surface ID may be the same for many interface IDs.</p>
</div>
<div class="paragraph">
<p>The Loads object stores a mapping of all interface IDs to the respective surface IDs in the CCM. When requesting the result variable&#8217;s memory location, this mapping is used to deliver the correct input variable reference/memory location to the interface-specific solar radiation calculation object.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_model_objects_published_variables_and_variable_look_up">3.2. Model objects, published variables and variable look-up</h3>
<div class="paragraph">
<p>Physical models are implemented in model objects. That means the code lines/equations compute results based on input values.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Model object</div>
<div class="content">
<div class="paragraph">
<p>A heating model takes room air temperature (state dependency) and a scheduled setpoint (time dependency) and computes a heating load as result.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The result is stored in a <strong>persistent memory location</strong> where dependent models can directly access this value.</p>
</div>
<div class="sect3">
<h4 id="_model_instances">3.2.1. Model instances</h4>
<div class="paragraph">
<p>There can be several model instances - the actual object code resides only once in solver memory, but the functions are executed several times for each individual object (=model instance).</p>
</div>
<div class="exampleblock">
<div class="title">Example 2. Model instance</div>
<div class="content">
<div class="paragraph">
<p>You may have a model that computes heat flux between walls and zones. For each wall-zone interface, an object is instantiated.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Each model instance stores its result values in own memory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_model_results">3.2.2. Model results</h4>
<div class="sect4">
<h5 id="_publishing_model_results">Publishing model results</h5>
<div class="paragraph">
<p>The model instances/objects must tell the solver framework what kind of outputs they generate. Objects generating results must derive from class <code>AbstractModel</code> (or derived helper classes) and implement the abstract interface functions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Schedules</code> and <code>FMIInputOutput</code> models are handled differently, when it comes to retrieving generated results.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The framework first requests a reference type (prefix) via  <code>AbstractModel::referenceType()</code> of the model object. This reference type is used to group model objects into meaningful object groups.</p>
</div>
<div class="exampleblock">
<div class="title">Example 3. Reference types</div>
<div class="content">
<div class="paragraph">
<p>Typical examples are <code>MRT_ZONE</code> for zonal quantities, or <code>MRT_INTERFACE</code> for quantities (fluxes) across wall-surfaces.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Each invididual result variable is published by the model in an object of type <code>QuantityDescription</code>. The framework requests these via call to <code>AbstractModel::resultDescriptions()</code>. Within the <code>QuantityDescription</code> structure,  the model stores for each computed quantity the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>id-name (e.g. "Temperature")</p>
</li>
<li>
<p>physical display unit (e.g. "C") - interpreted as "display unit", calculations are always done in base SI units</p>
</li>
<li>
<p>a descriptive text (e.g. "Room air temperature") (optional, for error/information messages)</p>
</li>
<li>
<p>physical limits (min/max values) (optional, may be used in iterative algorithms)</p>
</li>
<li>
<p>flag indicating whether this value will be constant over the lifetime of the solver/integration interval</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">A note on units</div>
<div class="paragraph">
<p>The results are stored <em>always</em> in base SI units according to the IBK-UnitList. A well-behaving model will always store the result value in the basic SI unit, that is "K" for temperatures, "W" for thermal loads and so on (see <code>IBK::UnitList</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The unit is really only provided for error message outputs and for checking of the base SI unit matches the base SI unit of the requested unit (as an additional sanity check).</p>
</div>
</div>
<div class="sect4">
<h5 id="_vector_valued_results">Vector-valued results</h5>
<div class="paragraph">
<p>Sometimes, a model may compute a vector of values.</p>
</div>
<div class="exampleblock">
<div class="title">Example 4. Vector results</div>
<div class="content">
<div class="paragraph">
<p>A ventilation model may compute ventilation heat loads for a number of zones (zones that are identified via object lists).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>When a so-called vector-valued quantity is generated, the following additional information is provided:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>whether index-based or id-based access is anticipated</p>
</li>
<li>
<p>a list of ids/indexes matching the individual positions in the vector (the size of the vector is also the size of the vector-valued quantities)</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="title">Example 5. ID-access example</div>
<div class="content">
<div class="paragraph">
<p>The aforementioned ventilation model may be assigned to zones with IDs 1,4,5,10 and 11. Then the resulting ventilation heat losses will be defined for those zones only. Hence, the published quantity will look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>- name = "NaturalVentilationHeadLoad"
- unit = "W"
- description = "Natural ventilation heat load"
- index-key-type = "ID"
- ID-list = {1,4,5,10,11}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Strong uniqueness requirement</div>
<div class="paragraph">
<p>The id-names of quantities are unique within a model object, and vector-valued quantities may not have the same ID name as scalar quantities. More precisely, variables need to be globally unique (see <a href="#variable_lookup">lookup rules</a> below). This means that when there are two models with the same model-reference-type, the variable names must be unique among all models with the same reference-type.</p>
</div>
<div class="paragraph">
<p>For example: from a zone parametrization several models are instantiated with the same reference-type <code>MRT_ZONE</code>, for example <code>RoomBalanceModel</code> and <code>RoomStatesModel</code>. The resulting variables in both models <em>must not</em> have the same ID name, in order to be uniquely identified on global scope.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_initializing_memory_for_result_values">Initializing memory for result values</h5>
<div class="paragraph">
<p>Each model object is requested by the framework in a call to <code>AbstractModel::initResults()</code> to reserve memory for its result variables. For scalar variables this is usually just resizing of a vector of doubles to the required number of result values. For vector-valued quantities the actual size may only be known later, so frequently here just the vectors are created and their actual size is determined later.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the information collected in <code>initResults()</code> is also needed when publishing the results to the framework, the function <code>AbstractModel::initResults()</code> is called before <code>AbstractModel::resultDescriptions()</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_convenience_implementation">Convenience implementation</h6>
<div class="paragraph">
<p>Scalar variables are stored in double variables of the model. When using the convenience implementation in <code>DefaultModel</code> these are stored in vector <code>m_results</code>.</p>
</div>
<div class="paragraph">
<p>Vector-valued variables are stored in consecutive memory arrays with size matching the size of the vector. When using the <code>DefaultModel</code> implementation, these are stored in <code>m_vectorValuedResults</code>, which is a vector of <code>VectorValuedResults</code>.</p>
</div>
<div class="paragraph">
<p>The <code>DefaultModel</code> implementation makes use of enumerations <code>Results</code> and <code>VectorValuedResults</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="model_input_refs">3.2.3. Model inputs</h4>
<div class="paragraph">
<p>Similarly as output variables, model objects need input variables. Models requiring input must implement the interface of class <code>AbstractStateDependency</code>.</p>
</div>
<div class="paragraph">
<p>Input variable requirements are published similarly to results when the framework requests them in a call to <code>AbstractStateDependency::inputReferences()</code>. The information on requested results is stored in objects of type <code>InputReference</code>. The data in class <code>InputReference</code> is somewhat similar to that of <code>QuantityDescription</code> but contains additional data regarding the expectations of the model in the input variable.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A model may request scalar variable inputs only, even if the providing model generates these as a vector-valued quantity. That means, a model has the choice to request access to the entire vector-valued variable (and will usually get the address to the start of the vector-memory space), or a single component of the vector. In the latter case, the index/model-ID must be defined in the <code>InputReference</code> data structure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="title">Example 6. Input reference to a zone air temperature inside a ventilation model</div>
<div class="content">
<div class="paragraph">
<p>An input required by the ventilation model can be formulated with the follwing data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>- reference type = MRT_ZONE
- object_id = 15 (id of the zone)
- name = "AirTemperature"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Given that information, the framework can effectively look-up the required variables.</p>
</div>
<div class="paragraph">
<p>Once the variable has been found, the framework will tell the object the memory location by calling <code>AbstractStateDependency::setInputValueRef()</code>.</p>
</div>
<div class="sect4">
<h5 id="_fmi_export_output_variables">FMI Export (output) variables</h5>
<div class="paragraph">
<p>When FMI export is defined, i.e. output variables are declarted in the FMI interface, a list of global variable IDs to be exported is defined. For each of these variables an input reference is generated (inside the <code>FMIInputOutput</code> model), just as for any other model as well.</p>
</div>
<div class="exampleblock">
<div class="title">Example 7. FMI Output Variable example</div>
<div class="content">
<div class="paragraph">
<p>Suppose an FMI exports the air temperature from zone id=15 and for that purpose needs to retrieve the currently computed temperature from the zone state model. The FMI output variable would be named <em>Zone[15].AirTemperature</em> and the input reference would be created as in the example above. This way, the framework can simply provide a pointer to this memory slot to the <code>FMIInputOutput</code> model just as for any other model.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_outputs">Outputs</h5>
<div class="paragraph">
<p>When initializing outputs, any published variable can be collected. Outputs declare their input variables just as any other model object.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="variable_lookup">3.2.4. Variable lookup</h4>
<div class="paragraph">
<p>The frameworks job is to collect all</p>
</div>
<div class="sect4">
<h5 id="_resolving_persistant_pointers_to_result_locations">Resolving persistant pointers to result locations</h5>
<div class="paragraph">
<p>Later, when the framework connects <a href="#model_input_refs">model inputs</a> with results, the framework requests models to provide persistant memory locations for previously published results. This is done by calling <code>AbstractModel::resultValueRef()</code>, which get&#8217;s a copy of the previously exported <code>InputReference</code>.</p>
</div>
<div class="paragraph">
<p>In order to uniquely identify a result variable <strong>within</strong> a model, normally only two things are needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the ID name of the variable,</p>
</li>
<li>
<p>and, <em>only in the case of vector-valued quantities</em>, the index/id.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, in some cases, a model may request a variable with the <em>same quantity</em> name, yet from two different objects (for example, the air temperature of neighbouring zones). In this case, the quantity name alone is not sufficient. Hence, the full input reference including object ID is passed as identifier (<strong>A change from NANDRAD 1!</strong>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To identify an element within a vector-valued result it is not necessary to specify whether it should be index or id based - the model publishing the result defines whether it will be index or id based access.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Naturally, for scalar result variables the index/id property is ignored.</p>
</div>
<div class="paragraph">
<p>The <code>QuantityName</code> struct contains this information (a string and an integer value).</p>
</div>
<div class="paragraph">
<p>Now the model searches through its own results and tries to find a matching variable. In case of vector-valued quantities it also checks if the requested id is actually present in the model, and in case of index-based access, a check is done if the index is in the allowed range (0&#8230;&#8203;size-1).</p>
</div>
<div class="paragraph">
<p>If a quantity could be found, the corresponding memory address is returned, otherwise a nullptr. The framework now can take the address and pass it to any object that requires this input.</p>
</div>
</div>
<div class="sect4">
<h5 id="_global_lookup_rulesglobal_variable_referencing">Global lookup rules/global variable referencing</h5>
<div class="paragraph">
<p>To uniquely reference a resulting variable (and its persistent memory location), first the actual model object/instance need to be selected with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the type of object to search for (= reference-type property), for example <code>MRT_ZONE</code> or <code>MRT_CONSTRUCTIONINSTANCE</code></p>
</li>
<li>
<p>ID of the referenced object, i.e. zone id oder construction id.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some model objects exist only once, for example schedules or climatic loads. Here, the reference-type is already enough to uniquely select the object.</p>
</div>
<div class="paragraph">
<p>Usually, the information above does select several objects that have been created from the parametrization related to that ID. For example, the zone parameter block for some zone ID generates several zone-related model instances, all of which have the same ID. Since their result variables are all different, the framework simply searches through all those objects until the correct variable is found. These model implementations can be thought of as one model whose equations are split up into several implementation units.</p>
</div>
<div class="paragraph">
<p>The actual variable <em>within</em> the selected object is found by ID name and optionally vector-element id/index, as described above.</p>
</div>
<div class="paragraph">
<p>The data is collected in the class <code>InputReference</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ObjectReference</code> ( holds reference-type and referenced-object ID )</p>
</li>
<li>
<p><code>QuantityName</code> (holds variable name and in case of vector-valued quantities also ID/index)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, it is possible to specify a <code>constant</code> flag to indicate, that during iterations over cycles the variable is to be treated constant.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If several model objects are addressed by the same reference-type and ID (see example with models from zone parameter block), the variable names must be unique among all of these models.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_fmi_input_variable_overrides">FMI Input variable overrides</h5>
<div class="paragraph">
<p>Any input variable requested by any other model can be overridden by FMU import variables. When the framework looks up global model references, and an FMU import model is present/parametrized, then first the FMI generated quantity descriptions are checked. The FMU import variables are exported as global variable references (with ObjectReference). Since these are then the same global variable identifiers as published by the models, they are found first in the search and dependent models will simply store points to the FMU variable memory.</p>
</div>
</div>
<div class="sect4">
<h5 id="_examples_for_referenced_input_quantities">Examples for referenced input quantities</h5>
<div class="sect5">
<h6 id="_setpoint_from_schedules">Setpoint from schedules</h6>
<div class="paragraph">
<p>Schedules are defined for object lists. Suppose you have an object list name "Living rooms" and corresponding heating/cooling setpoints.</p>
</div>
<div class="paragraph">
<p>Now a heating model may be defined that computes heating loads for a given zone. The heating model is implemented with a simple P-controller, that requires zone air temperature and zone heating setpoint.</p>
</div>
<div class="paragraph">
<p>Definition of the input reference for the zone air temperature is done as in the example above. The setpoint will be similarly referenced:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>- reference type = MRT_ZONE
- object_id = 15 (id of the zone)
- name = "HeatingSetPoint"</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sim_vicus_user_interface">4. SIM-VICUS User-Interface</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_3d_engine">4.1. 3D Engine</h3>
<div class="sect3">
<h4 id="_camera">4.1.1. Camera</h4>
<div class="ulist">
<ul>
<li>
<p>world-2-view-translation = m_projection * m_camera * m_transform</p>
</li>
<li>
<p>transform only for "movable objects" (e.g. objects in selection)</p>
</li>
<li>
<p>Local coordinate system of camera = left handed coordinate system with y-axis pointing downwards and z-axis pointing towards user</p>
<div class="literalblock">
<div class="content">
<pre>+ right = towards right of screen
+ up = pointing downwards
+ forward = towards the viewer</pre>
</div>
</div>
</li>
<li>
<p>camera object without translation and rotation &#8594; x and y coordinates map to i-j coordinates of screen (0,0 top left; 1,1 bottom right), so that point x,y,z = (-50,-200,0) becomes i,j = (-100, 400) (bottom left) in screen coordinates.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_navigation">4.1.2. Navigation</h4>
<div class="paragraph">
<p>Die Kamera kann mittels Tastatur- und Mauseingaben verschoben und gedreht werden.</p>
</div>
<div class="paragraph">
<p>Tastaturnavigation erfolgt mit den Tasten W, A (Vor- und Zurück), S, D (nach links, nach rechts verschieben), R, F (hoch oder runter verschieben), Q, E (links oder rechts um die globale Z-Achse drehen).</p>
</div>
<div class="paragraph">
<p>Mit der Maus sind 4 verschiedene Operationen möglich:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First-Persion-View-Modus: beim Halten der rechten Maustaste führt die Mausbewegung um einen Kameraschwenk um die Kameraposition</p>
</li>
<li>
<p>Verschieben der Kamera: beim Halten der mittleren Maustaste wird die Kamera so verschoben, sodass der angeklickte Punkt unter dem Cursor bleibt.</p>
</li>
<li>
<p>Orbit-Modus: beim Halten der linken Maustaste bewegt und rotiert sich die Kamera um den angeklickten Punkt.</p>
</li>
<li>
<p>Schneller Vor-/Zurück-Modus: beim Bewegen des Scroll-Rads bewegt sich die Kamera schnell vor/zurück entlang der aktuellen Sichtrichtung. Ist gleichzeitig die linke Maustaste gedrückt, so bewegt sich die Kamera entlang der Sichtline auf den angeklickten Punkt zu.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Die Operation 1-3 sind exclusive, d.h. man kann stets nur eine gleichzeitig ausführen.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_transfer">4.1.3. Data transfer</h4>
<div class="ulist">
<ul>
<li>
<p>original geometry in object coordinates (world coordinate for now)</p>
</li>
<li>
<p>opaque geometry = planes</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_primitive_assembly">Primitive Assembly</h5>
<div class="ulist">
<ul>
<li>
<p>planes:</p>
<div class="ulist">
<ul>
<li>
<p>type triangle</p>
</li>
<li>
<p>type rect</p>
</li>
<li>
<p>type polygon</p>
</li>
</ul>
</div>
</li>
<li>
<p>plane type affects selection algorithm: triangle/rect trivial; polygon = test individual triangles (more work)</p>
</li>
<li>
<p>data on VBO first stored on heap (vector of vertex struct); additional vector for rgba colors</p>
</li>
<li>
<p>plane transfer vectors, type-specific transfer:</p>
<div class="ulist">
<ul>
<li>
<p>append vertices + colors</p>
</li>
<li>
<p>store element indexes in triangle-strip order</p>
</li>
<li>
<p>append primitive restart index, see <a href="https://www.khronos.org/opengl/wiki/Vertex_Rendering#Primitive_Restart" class="bare">https://www.khronos.org/opengl/wiki/Vertex_Rendering#Primitive_Restart</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>triangles: copy 3 vertices counter-clock-wise; append element indexes +0, +1, +2</p>
</li>
<li>
<p>rectangle: copy 4 vertices counter-clock-wise; append element indexes +0, +1, +2; +1 +3 +2</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_triangle_strips">Triangle Strips</h5>
<div class="paragraph">
<p>See also explanation in <a href="https://www.learnopengles.com/tag/triangle-strips" class="bare">https://www.learnopengles.com/tag/triangle-strips</a>.</p>
</div>
<div class="paragraph">
<p>See polygon in <a href="#fig_trianglestrip_polygon">Figure 3</a>. Index list to draw the polygon is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1, 2, 6, 5, 3, 4</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>First triangle is <code>1, 2, n</code> (anti-clock-wise - order of first triangle defines order of the rest).</p>
</li>
<li>
<p>Second triangle is <code>2, n-1, n</code></p>
</li>
<li>
<p>Third triangle is <code>n, 3, n-1</code></p>
</li>
<li>
<p>Fourth triangle is <code>3, n-2, n-1</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>in an algorithm keep adding indexes until you would duplicate an existing node index</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div id="fig_trianglestrip_polygon" class="imageblock">
<div class="content">
<img src="./images/TriangleStrip1.png" alt="TriangleStrip1">
</div>
<div class="title">Figure 3. Generation of a triangle strip from a polygon</div>
</div>
<div class="paragraph">
<p>When drawing several triangle strips one after another, we need primitive restart (to have gaps between triangles).</p>
</div>
<div class="paragraph">
<p>Consider strips in <a href="#fig_trianglestrip_restart">Figure 4</a>. Top part of the figure shows two strips where the first strip ends with an <em>odd numbered</em> triangle. Bottom part shows the first strip ending with an <em>even numbered</em> triangle.</p>
</div>
<div id="fig_trianglestrip_restart" class="imageblock">
<div class="content">
<img src="./images/TriangleStrip2.png" alt="TriangleStrip2">
</div>
<div class="title">Figure 4. Primitive restart using degenerated triangles</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_shaders">4.1.4. Shaders</h4>
<div class="paragraph">
<p>Vertex-Layout notation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>V - single coordinate (e.g. x-coordinate)</p>
</li>
<li>
<p>N - component of normal vector</p>
</li>
<li>
<p>C - color component (e.g. CCC for RGB)</p>
</li>
<li>
<p>T - texture coordinate</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_grid">Grid</h5>
<div class="ulist">
<ul>
<li>
<p>Shader-Index: 0</p>
</li>
<li>
<p>Vertex-Structure: (VV) = (xz)</p>
</li>
<li>
<p>Files: <code>grid.vert</code> and <code>grid.frag</code></p>
</li>
<li>
<p>Uniforms (variables):</p>
<div class="ulist">
<ul>
<li>
<p><code>worldToView</code></p>
</li>
<li>
<p><code>gridColor</code></p>
</li>
<li>
<p><code>backColor</code> (fade-to color)</p>
</li>
<li>
<p>(optional) <code>farDistance</code> (fade-to normalization distance)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_background_objects">Background Objects</h5>
<div class="paragraph">
<p>Uniform color, no lighting effect, no transparency</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Shader-Index: 1</p>
</li>
<li>
<p>Vertex-Structure: (VVVCCC) = (xyzrgb)</p>
</li>
<li>
<p>Files: <code>vertexColor.vert</code> and <code>flat.frag</code></p>
</li>
<li>
<p>Uniforms (variables):</p>
<div class="ulist">
<ul>
<li>
<p><code>worldToView</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_regular_opaque_objects">Regular Opaque Objects</h5>
<div class="ulist">
<ul>
<li>
<p>Shader-Index: 2</p>
</li>
<li>
<p>Vertex-Structure: (VVVNNNCCC) = (xyzNxNyNzrgb)</p>
</li>
<li>
<p>Files: <code>vertexNormalColor.vert</code> and <code>specularShading.vert</code></p>
</li>
<li>
<p>Uniforms (variables):</p>
<div class="ulist">
<ul>
<li>
<p><code>worldToView</code></p>
</li>
<li>
<p><code>lightPos</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3d_calculations">4.2. 3D Calculations</h3>
<div class="paragraph">
<p>This chapter describes/discusses many of the unterlying 3D geometry calculations
used in SIM-VICUS.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We are dealing with limited number precision when performing geometry calculations. Hence, when checking for same vertexes, collinearity, and many other properties we need to deal with a little bit of fuzzyness. For example, the vertexes (0,1,0) and (1e-4, 0.9999, -1e.4) should be treated the same.</p>
</div>
<div class="paragraph">
<p>Generally speaking, we need to define a (problem specific) <em>relative</em> and <em>absolute tolerance</em> to be used when comparing geometrical properties.</p>
</div>
<div class="paragraph">
<p>However, in the implementation we often use comparisons with cached variables to avoid updates when no changes have been made. In these comparisons we need to check for exactly the same values.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_polygons">4.2.1. Polygons</h4>
<div class="paragraph">
<p>Polygons are defined through lists of vertexes. There can be valid and invalid polygons.</p>
</div>
<div class="sect4">
<h5 id="_valid_polygons">Valid polygons</h5>
<div class="paragraph">
<p>Valid polygons have the following properties:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>there are at least 3 vertexes</p>
</li>
<li>
<p>all vertexes must lie in a plane (within given tolerance limit)</p>
</li>
<li>
<p>all vertices are different (within given tolerance limit)</p>
</li>
<li>
<p>two subsequent edges are not collinear (within given tolerance limit)</p>
</li>
<li>
<p>polygon is not winding (i.e. no two edges cross)</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_reducing_vertex_lists_to_get_valid_polygons">Reducing vertex lists to get valid polygons</h5>
<div class="paragraph">
<p>When drawing a polygon or starting with a given set of vertexes, we can remove vertexes that would violate any of the rules above in the following manner:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>remove subsequent vertexes which are the same</p>
</li>
<li>
<p>compute edge direction vectors, and if two adjacent edge direction vectors are collinear, remove the middle vertex</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_normal_vector_calculation_of_polygons">4.2.2. Normal vector calculation of polygons</h4>
<div class="paragraph">
<p>Polygons are expected to be not-winding and defined in counter-clockwise manner. Then, the normal vector of the polygon can be created by computing the cross product of two adjacent edges. However, if polygons are concave, the sign of the normal vector depends on the edge being selected. <a href="#fig_concave_polygon">Figure 5</a> shows a concave polygon.</p>
</div>
<div id="fig_concave_polygon" class="imageblock">
<div class="content">
<img src="./images/polygon_normal_vector.svg" alt="polygon normal vector">
</div>
<div class="title">Figure 5. Concave polygon example</div>
</div>
<div class="paragraph">
<p>Suppose the following vertex coordinates define the polygon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1:   4,0,0
2:   2,2,0
3:   4,3,0
4:   0,4,0
5:   0,0,0</pre>
</div>
</div>
<div class="paragraph">
<p>If we select vertexes 1, 2 and 3 and compose the cross product of the enclosed edges, we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>a = v1-v2 = (2,-2,0)
b = v3-v2 = (2,1,0)
n = a x b = (0,0,6) (pointing upwards)</pre>
</div>
</div>
<div class="paragraph">
<p>If we select vertexes 2, 3 and 4 we get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>a = v2-v3 = (-2,-1,0)
b = v4-v3 = (-4,1,0)
n = a x b = (0,0,-6)  (pointing downwards)</pre>
</div>
</div>
<div class="paragraph">
<p>So, just picking a random point and computing the cross product between the adjacent edges <em>does not work</em>.</p>
</div>
<div class="paragraph">
<p>Since we do a triangulation for any valid polygon anyways (needed for drawing purposes), we can then easily just take any of the generated triangles and compute the normal of the triangle (all triangles will have the same normal vector).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We actually need to compute the normal vector already <strong>before</strong> we have a triangulation: for checking if all vertexes lie in a plane. However, for this check the sign of the normal vector is of no importance, and once the triangulation has been computed, we just update the normal vector with the correct one.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_zustand_der_benutzeroberfläche_view_state">4.3. Zustand der Benutzeroberfläche (View State)</h3>
<div class="paragraph">
<p>Die Benutzeroberfläche hat verschiedene Zustände, wobei ein Zustand beschreibt:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>welche Ansicht ein Widget zeigt, z.B. welches Property-Widget gerade aktiv/sichtbar ist</p>
</li>
<li>
<p>welche Maus-/Tastaturinteraktionsmöglichkeiten bestehen, z.B. was die linke
Maustaste bewirkt oder welche Snap-Funktionen eingeschaltet sind</p>
</li>
<li>
<p>was die Szene anzeigt (z.B. lokales Koordinatensystem sichtbar oder nicht)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Da das Verändern eines Zustands mehrere Teile der Oberfläche (und damit mehrere Objekte)
betrifft, wird das Ändern des Oberflächenzustands zentralisiert über einen
Zustandsmanager (<code>SVViewStateHandler</code>) erledigt.
Beim Setzen eines neuen Zustands sendet dieser ein Signal aus.</p>
</div>
<div class="paragraph">
<p>Alle Widgets/Objekte, die sich in Abhängigkeit des
Zustands verändern müssen, sollten auf dieses Signal reagieren und sich
entsprechend anpassen.</p>
</div>
<div class="paragraph">
<p>Eine Veränderung des Zustands kann überall in der Programmoberfläche ausgelöst werden und
erfolgt in folgenden Schritten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>holen des aktuellen Zustands (Objekt <code>ViewState</code>)</p>
</li>
<li>
<p>anpassen des Zustandsbeschreibungsobjekts</p>
</li>
<li>
<p>setzen des neuen Zustands</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="c1">// aktuellen ViewState holen</span>
<span class="n">ViewState</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">SVViewStateHandler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">viewState</span><span class="p">();</span>
<span class="c1">// anpassen</span>
<span class="n">vs</span><span class="p">.</span><span class="n">m_sceneOperationMode</span> <span class="o">=</span> <span class="n">OM_SelectedGeometry</span><span class="p">;</span>
<span class="n">vs</span><span class="p">.</span><span class="n">m_propertyWidgetMode</span> <span class="o">=</span> <span class="n">PM_EditGeometry</span><span class="p">;</span>
<span class="c1">// setzen</span>
<span class="n">SVViewStateHandler</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">setViewState</span><span class="p">(</span><span class="n">vs</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_viewmode">4.3.1. <code>ViewMode</code></h4>
<div class="paragraph">
<p>Umschalten erfolgt durch Modusauswahl-Schaltflächen in der linken Toolbar</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VM_GeometryEditMode</code> - wenn Geometrie bearbeitet wird; Geometrie wird mit definierten Oberflächen/Materialfarben dargestellt</p>
</li>
<li>
<p><code>VM_PropertyEditMode</code> - beim Eigenschaften ansehen/bearbeiten; Geometrie wird mit Falschfarben je nach Modus dargestellt</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Beim Umschalten zwischen den Modi wird die Geometrie neu eingefärbt und gezeichnet.</p>
</div>
<div class="paragraph">
<p>Im <code>VM_PropertyEditMode</code>: <code>NUM_OM</code> + <code>NUM_L</code> und <code>PropertyWidgetMode</code> wird je nach Auswahl im <code>SVPropModeSelectionWidget</code> gesetzt, genau wie
<code>ObjectColorMode</code>.</p>
</div>
<div class="paragraph">
<p>(ACHTUNG: Shortcuts zum Ändern des SceneOperationMode deaktivieren!)</p>
</div>
<div class="paragraph">
<p>Beim Einschalten des <code>VM_GeometryEditMode</code> wird unterschieden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Es gibt eine Auswahl von Flächen, dann: <code>OM_SelectedGeometry</code> + <code>PM_EditGeometry</code>
-</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="UI-SelectionHandling">4.4. Auswahl von Objekten</h3>
<div class="paragraph">
<p>Wenn die Benutzeroberfläche im Zustand:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Standard (NUM_OM)</p>
</li>
<li>
<p>OM_SelectedGeometry</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ist, kann man Objekte durch links-klicken auswählen. Alternativ kann man im Navigationsbaum auswählebare Objekte durch Ankreuzen der Auswahlboxen auswählen.</p>
</div>
<div class="sect3">
<h4 id="_auswahl_in_der_scene">4.4.1. Auswahl in der Scene</h4>
<div class="paragraph">
<p>Wenn ein Linksklick registriert wird, werden alle geometrischen Primitiven auf Kollision mit der Sichtgeraden geprüft und ggfs. selektiert/deselektiert. Dies erfolgt in der Funktion <code>Vic3DScene::handleSelection()</code>.</p>
</div>
<div class="paragraph">
<p>Hier wird zunächst die "pick"-Operation durchgeführt, wobei der Sichtstrahl konstruiert und die Kollisionsprüfung mit allen Objekten durchgeführt wird. Ist ein Objekt ermittelt, wird dieses eindeutig durch seinen uniqueID identifiziert. Alle Objekte im Navigationsbaum müssen eine solche haben, und sind deshalb von <code>VICUS::Object</code> abgeleitet. Diese Klasse speichert auch das "selected"-Flag.</p>
</div>
<div class="paragraph">
<p>Wurde ein Objekt angeklickt, wird eine Undo-Action vom Typ <code>SVUndoTreeNodeState</code> erstellt. Diese sammelt zunächst basierend auf der übergebenen uniqueID alle zu verändernden Elemente aus.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="UI-object_picking">4.5. Objekt-Pick-Operation</h3>
<div class="paragraph">
<p>Die Erkennung, was sich unter dem Mauscursor befindet, kann unterschiedliche Ergebnisse haben, je nach Konfiguration. Dafür wird zunächst ein <code>PickObject</code> erstellt und konfiguriert und dann dem Pick-Algorithmus übergeben.</p>
</div>
<div class="paragraph">
<p>Optionen sind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>XY_Plane</code> - es wird ein Schnittpunkt mit der XY-Ebene bestimmt</p>
</li>
<li>
<p><code>Surface</code> - es werden alle Oberflächen geprüft</p>
</li>
<li>
<p><code>Network</code> - es werden Netzwerkobjekte (Nodes/Edges) geprüft</p>
</li>
<li>
<p><code>Backside</code> - es werden auch die Rückseiten von Objekten geprüft</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nandrad_fmu">5. NANDRAD FMU</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_debugging_nandrad_fmus_mit_qt_creator_und_mastersim">5.1. Debugging NANDRAD FMUs mit Qt Creator und MasterSim</h3>
<div class="sect3">
<h4 id="_linux_2">5.1.1. Linux</h4>
<div class="ulist">
<ul>
<li>
<p>MasterSim von SourceForge herunterladen</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>oder</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MasterSim-Repository von SourceForge herunterladen und mit CMake kompilieren</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es wird ein statisch gelinktes <code>MasterSimulator</code>-Programm benötigt.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_aufsetzen_der_co_simulation">Aufsetzen der Co-Simulation</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ein Co-simulationsprojekt in MasterSim erstellen und speichern, beispielsweise unter <code>/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation.msim</code></p>
</li>
<li>
<p>einmal mit <em>MasterSimulator</em> ausführen:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> /path/to/MasterSimulator /home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation.msim</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dies erstellt die übliche Verzeichnisstruktur unter: <code>/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation.msim</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_qt_creator_für_das_fmu_debuggen_konfigurieren">Qt-Creator für das FMU-Debuggen konfigurieren</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Qt Creator öffnen</p>
</li>
<li>
<p>Modus "Projekte" öffnen</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_DebugFmuConfig.png" alt="QtCreator DebugFmuConfig">
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>In der Rubrik "Ausführen", in der Zeile mit "Ausführungskonfiguration" (da steht normalerweise <em>SIM-VICUS</em> oder <em>NandradSolver</em> drin) auf "Add&#8230;&#8203;" klicken</p>
</li>
<li>
<p>In der Liste "Benutzerdefinierte ausführbare Datei" anklicken und bestätigen &#8594; es wird eine neue Ausführungskonfiguration erstellt.</p>
</li>
<li>
<p>Wie in der Abbildung oben zu sehen eintragen:</p>
<div class="ulist">
<ul>
<li>
<p>(rot) Pfad zum <em>MasterSimulator</em> Programm</p>
</li>
<li>
<p>(blau) Pfad zur <code>msim</code>-Projektdatei und zusätzlich das Argument <code>--skip-unzip</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Dann unten bei der Ausführungsumgebung die Details ausklappen</p>
</li>
<li>
<p>Die Umgebungsvariable <code>LD_LIBRARY_PATH</code> hinzufügen, und als Wert den Pfad zum <code>SIM-VICUS/externals/lib_x64:</code> Pfad eintragen; MasterSim muss beim Laden der FMU-Bibliothek alle von ihr gelinkten, dynamischen Bibliotheken finden.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Jetzt kann man den Debugger starten (F5) und man müsste MasterSim durchlaufen sehen.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Trotz der Angabe von <code>--skip-unzip</code> führt MasterSimulation die vorher entpackte FMU-shared-Library aus. Also im Beispiel mit der <code>coSimulation.msim</code> soll eine FMU <code>singleRoom.fmu</code> simuliert werden. Die dazugehörige Shared Library liegt dann in:</p>
</div>
<div class="paragraph">
<p><code>/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation.msim/fmus/singleRoom/binaries/linux64/singleRoom.so</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Wenn man im QtCreator irgendwo einen Breakpoint setzt, und dann in der Debugger-Module-Ansicht die geladenen Shared Libraries ansieht, kann man diesen Pfad wiederfinden.</p>
</div>
<div class="paragraph">
<p>Beispiel:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MasterSim Projekt: <code>/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation.msim</code></p>
</li>
<li>
<p>Lib-Pfad: <code>/home/ghorwin/git/SIM-VICUS/externals/lib_x64/</code></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/QtCreator_DebugFmuLoadedLibs.png" alt="QtCreator DebugFmuLoadedLibs">
</div>
<div class="title">Figure 6. Ausgabe im QtCreator gleich nach Anhalten der Simulation in <code>fmi2Instantiate</code></div>
</div>
<div class="ulist">
<ul>
<li>
<p>(rosa) Im Bild <strong>rosa</strong> markiert sind die geladenen FMUs im Co-Simulationsszenario.</p>
</li>
<li>
<p>(grün) Im Bild <strong>grün</strong> markiert sind die davon abhängigen Bibliotheken</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Es kann jetzt sein, dass die FMU-Bibliothek im <code>.fmu</code> Archiv gegen ältere Versionen der abhängigen Bibliotheken gelinkt worden ist. In diesem Fall kann es zu Zugriffsverletztungen und harten Crashs kommen.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_debuggen_der_aktuellen_entwicklungsversion">Debuggen der aktuellen Entwicklungsversion</h5>
<div class="paragraph">
<p>Löscht man die "alte" FMU Bibliothek aus dem binaries/linux64-Verzeichnis erhält man eine Fehlermeldung, z.B.</p>
</div>
<div class="paragraph">
<p><code>Shared library '/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation/fmus/singleRoom/binaries/linux64/singleRoom.so' does not exist.</code></p>
</div>
<div class="paragraph">
<p>Man erstellt nun einen Symlink auf die aktuell entwickelte FMU-Bibliothek an Stelle der originalen FMU-Bibliothek, welche von MasterSim geladen wird.</p>
</div>
<div class="paragraph">
<p>Im Verzeichnis: <code>/home/ghorwin/git/SIM-VICUS/data/fmu/coSimulation/fmus/singleRoom/binaries/linux64/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">ln</span> <span class="nt">-s</span> /home/ghorwin/git/SIM-VICUS/bin/debug_x64/libNandradSolverFMI.so singleRoom.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dies erstellt eine symbolische Verknüpfung zur gerade entwickelten Bibliothek <code>libNandradSolverFMI.so</code>.</p>
</div>
<div class="paragraph">
<p>Wenn man nun den Debugger startet, lädt MasterSim stattdessen diese aktuelle Bibliothek. Damit der symbolische Link nicht wieder überschrieben wird, muss das Argument <code>--skip-unzip</code> verwendet werden.</p>
</div>
<div class="paragraph">
<p>Nun kann man die FMU ganz normal debuggen.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_patchesdiffs">6. Patches/Diffs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_änderungen_in_abgeleiteten_projekten_übernehmen">6.1. Änderungen in abgeleiteten Projekten übernehmen</h3>
<div class="sect3">
<h4 id="_ausgangspunkt">6.1.1. Ausgangspunkt</h4>
<div class="paragraph">
<p>Es gibt eine VICUS oder NANDRAD Projektdatei im ASCII-Format. Es werden davon mittels Texteditor modifizierte Versionen erstellt, Beispiel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># Original</span>
Reihenhaus_Basis.nandrad
<span class="c"># Variante mit Fußbodenheizung</span>
Reihenhaus_Fussbodenheizung.nandrad
<span class="c"># Variante mit FMU Interface B1</span>
B1_Reihenhaus_Fussbodenheizung_FMI.nandrad</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Änderungen zwischen zwei Dateiversionen lassen sich grafisch z.B. mit <code>meld</code> oder <code>kompare</code> anzeigen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> meld Reihenhaus_Basis.nandrad Reihenhaus_Fussbodenheizung.nandrad
<span class="c"># oder</span>
<span class="o">&gt;</span> kompare Reihenhaus_Basis.nandrad Reihenhaus_Fussbodenheizung.nandrad</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Änderung von Datei 1 zu 2 lassen sich mit dem Befehl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> diff <span class="nt">-U</span> 3 <span class="nt">-dHrN</span> <span class="nt">--</span> Reihenhaus_Basis.nandrad Reihenhaus_Fussbodenheizung.nandrad</code></pre>
</div>
</div>
<div class="paragraph">
<p>als <strong>diff</strong> vereinigt in der Konsole anzeigen, z.B.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="diff"><span class="gd">--- Townhouse_reference_210609.nandrad	2021-06-11 14:54:46.000000000 +0200
</span><span class="gi">+++ B1_Townhouse_1_210614.nandrad	2021-06-11 15:47:29.000000000 +0200
</span><span class="p">@@ -351,6 +351,7 @@</span>
 				&lt;/MaterialLayers&gt;
 			&lt;/ConstructionType&gt;
 			&lt;ConstructionType id="20006" displayName="[FMI4BIM] Town house Floor Upper Floor"&gt;
<span class="gi">+			&lt;ActiveLayerIndex&gt;1&lt;/ActiveLayerIndex&gt;
</span> 				&lt;MaterialLayers&gt;
 					&lt;MaterialLayer thickness="0.015" matId="10017" /&gt;
 					&lt;MaterialLayer thickness="0.065" matId="10019" /&gt;
<span class="p">@@ -424,15 +425,29 @@</span>
 						&lt;/DailyCycles&gt;
 					&lt;/Schedule&gt;
 				&lt;/ScheduleGroup&gt;
<span class="gi">+				&lt;ScheduleGroup objectList="[FMI4BIM] Townhouse Adapter"&gt;
+					&lt;Schedule type="AllDays"&gt;
+						&lt;DailyCycles&gt;
+							&lt;DailyCycle interpolation="Constant"&gt;
+								&lt;TimePoints&gt;0&lt;/TimePoints&gt;
+								&lt;Values&gt;FluidOutletSetpointSchedule [C]:40&lt;/Values&gt;
+							&lt;/DailyCycle&gt;
+							&lt;DailyCycle interpolation="Constant"&gt;
+								&lt;TimePoints&gt;0&lt;/TimePoints&gt;
+								&lt;Values&gt;SupplyMassFlowSchedule [kg/s]:0.05&lt;/Values&gt;
+							&lt;/DailyCycle&gt;
+						&lt;/DailyCycles&gt;
+					&lt;/Schedule&gt;
+				&lt;/ScheduleGroup&gt;
</span> 			&lt;/ScheduleGroups&gt;
 		&lt;/Schedules&gt;
 		&lt;Models&gt;
 			&lt;NaturalVentilationModels&gt;
<span class="gd">-				&lt;NaturalVentilationModel id="4" displayName="[FMI4BIM] Townhouse ZoneTemplate Living Space" modelType="Constant"&gt;
</span><span class="gi">+				&lt;NaturalVentilationModel id="5" displayName="[FMI4BIM] Townhouse ZoneTemplate Living Space" modelType="Constant"&gt;
</span> 					&lt;ZoneObjectList&gt;[FMI4BIM] Townhouse ZoneTemplate Living Space&lt;/ZoneObjectList&gt;
 					&lt;IBK:Parameter name="VentilationRate" unit="1/h"&gt;0.65&lt;/IBK:Parameter&gt;
 				&lt;/NaturalVentilationModel&gt;
<span class="gd">-				&lt;NaturalVentilationModel id="5" displayName="[FMI4BIM] Townhouse ZoneTemplate Roof" modelType="Constant"&gt;
</span><span class="gi">+				&lt;NaturalVentilationModel id="6" displayName="[FMI4BIM] Townhouse ZoneTemplate Roof" modelType="Constant"&gt;
</span> 					&lt;ZoneObjectList&gt;[FMI4BIM] Townhouse ZoneTemplate Roof&lt;/ZoneObjectList&gt;
 					&lt;IBK:Parameter name="VentilationRate" unit="1/h"&gt;1.1&lt;/IBK:Parameter&gt;
 				&lt;/NaturalVentilationModel&gt;
<span class="p">@@ -453,13 +468,29 @@</span>
 					&lt;ControllerType&gt;Analog&lt;/ControllerType&gt;
 				&lt;/Thermostat&gt;
 			&lt;/Thermostats&gt;
<span class="gd">-			&lt;IdealHeatingCoolingModels&gt;
-				&lt;IdealHeatingCoolingModel id="3"&gt;
-					&lt;ZoneObjectList&gt;[FMI4BIM] Townhouse ZoneTemplate Living Space&lt;/ZoneObjectList&gt;
</span><span class="gi">+			&lt;IdealSurfaceHeatingCoolingModels&gt;
+				&lt;IdealSurfaceHeatingCoolingModel id="3"&gt;
+					&lt;ThermostatZoneId&gt;13&lt;/ThermostatZoneId&gt;
+					&lt;ConstructionObjectList&gt;[FMI4BIM] Townhouse Ground Floor&lt;/ConstructionObjectList&gt;
</span> 					&lt;IBK:Parameter name="MaxHeatingPowerPerArea" unit="W/m2"&gt;50&lt;/IBK:Parameter&gt;
<span class="gd">-					&lt;IBK:Parameter name="MaxCoolingPowerPerArea" unit="W/m2"&gt;0&lt;/IBK:Parameter&gt;
-				&lt;/IdealHeatingCoolingModel&gt;
-			&lt;/IdealHeatingCoolingModels&gt;
</span><span class="gi">+				&lt;/IdealSurfaceHeatingCoolingModel&gt;
+				&lt;IdealSurfaceHeatingCoolingModel id="4"&gt;
+					&lt;ThermostatZoneId&gt;14&lt;/ThermostatZoneId&gt;
+					&lt;ConstructionObjectList&gt;[FMI4BIM] Townhouse Upper Floor&lt;/ConstructionObjectList&gt;
+					&lt;IBK:Parameter name="MaxHeatingPowerPerArea" unit="W/m2"&gt;50&lt;/IBK:Parameter&gt;
+				&lt;/IdealSurfaceHeatingCoolingModel&gt;
+			&lt;/IdealSurfaceHeatingCoolingModels&gt;
+			&lt;HeatLoadSummationModels&gt;
+				&lt;HeatLoadSummationModel id="7"&gt;
+					&lt;ObjectList&gt;All constructions&lt;/ObjectList&gt;
+				&lt;/HeatLoadSummationModel&gt;
+			&lt;/HeatLoadSummationModels&gt;
+			&lt;NetworkInterfaceAdapterModels&gt;
+				&lt;NetworkInterfaceAdapterModel id="8" summationModelId="7"&gt;
+					&lt;IBK:Parameter name="FluidHeatCapacity" unit="J/kgK"&gt;4180&lt;/IBK:Parameter&gt;
+				&lt;/NetworkInterfaceAdapterModel&gt;
+			&lt;/NetworkInterfaceAdapterModels&gt;
+
</span> 		&lt;/Models&gt;
 		&lt;Outputs&gt;
 			&lt;Definitions&gt;
<span class="p">@@ -468,6 +499,41 @@</span>
 					&lt;ObjectListName&gt;All zones&lt;/ObjectListName&gt;
 					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
 				&lt;/OutputDefinition&gt;
<span class="gi">+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;ActiveLayerThermalLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;All constructions&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;VentilationHeatLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;All zones&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;ConstructionHeatConductionLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;All zones&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;WindowHeatConductionLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;All zones&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;WindowSolarRadiationLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;All zones&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;TotalHeatLoad&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;Summation&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
+				&lt;OutputDefinition&gt;
+					&lt;Quantity&gt;ReturnTemperature&lt;/Quantity&gt;
+					&lt;ObjectListName&gt;[FMI4BIM] Townhouse Adapter&lt;/ObjectListName&gt;
+					&lt;GridName&gt;Hourly values&lt;/GridName&gt;
+				&lt;/OutputDefinition&gt;
</span> 			&lt;/Definitions&gt;
 			&lt;Grids&gt;
 				&lt;OutputGrid name="Hourly values"&gt;
<span class="err">
</span> 				... &lt;Rest abgeschnitten&gt;...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Ausgabe lässt sich in eine Datei umleiten:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> diff <span class="nt">-U</span> 3 <span class="nt">-dHrN</span> <span class="nt">--</span> Reihenhaus_Basis.nandrad Reihenhaus_Fussbodenheizung.nandrad <span class="o">&gt;</span> patch-zuFussbodenheizung.diff</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wird nun die originale Datei verändert, z.B. als <code>Reihenhaus_Basis_v1.nandrad</code> gespeichert, kann man die Änderungen erneut anwenden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">&gt;</span> patch Reihenhaus_Basis_v1.nandrad patch-zuFussbodenheizung.diff</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hierbei wird die Datei <code>Reihenhaus_Basis_v1.nandrad</code> verändert.</p>
</div>
<div class="paragraph">
<p>Das Ganze lässt sich geskriptet benutzen, um eine Reihe von aufeinander aufbauenden Dateien zu patchen.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Um Datenverlust bei Patchkonflikten zu vermeiden, sollte man das betreffende Verzeichnis und die zu patchenden Dateien in ein git-Repository einpacken, sodass man zur Not die Änderungen rückgängig machen kann.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-12-28 20:48:40 +0100
</div>
</div>
</body>
</html>